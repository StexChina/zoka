<!DOCTYPE html>
<html lang="sr-Latn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Zoka</title>
  <meta name="theme-color" content="#0f172a"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="manifest" href="./manifest.webmanifest?v=81">
  <style>
    /* Osnovna paleta (dark default) */
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#22c55e; --accent2:#3b82f6; --warn:#f59e0b; --danger:#ef4444;
      --chip:#1f2937; --card:#0b1220; --border:#1f2937;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial;line-height:1.35}

    header{position:sticky;top:0;z-index:30;backdrop-filter:saturate(1.2) blur(8px);
      background:rgba(11,17,32,.9);border-bottom:1px solid var(--border);
      padding:10px 12px}
    .header-top{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .title{font-weight:700;letter-spacing:.2px;font-size:18px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .tabs{display:flex;gap:8px;align-items:center;margin-top:8px}
    .tab{padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:#0d1426;cursor:pointer;color:#cbd5e1}
    .tab.active{background:#1f2937;color:#fff;border-color:#334155}

    button{border:1px solid var(--border);background:#121a2f;color:var(--text);padding:10px 12px;border-radius:10px;cursor:pointer}
    button.primary{background:linear-gradient(180deg,var(--accent2), #1d4ed8);border-color:#1e40af}
    button.success{background:linear-gradient(180deg,var(--accent), #16a34a);border-color:#15803d}
    button.warn{background:linear-gradient(180deg,var(--warn), #b45309);border-color:#b45309}
    button.danger{background:linear-gradient(180deg,var(--danger), #dc2626);border-color:#b91c1c}
    button.ghost{background:#0b122000}
    button:active{transform:translateY(1px)}
    input,select,textarea{background:#0b1220;color:var(--text);border:1px solid var(--border);
      padding:12px;border-radius:10px;outline:none;width:100%}
    input:focus,textarea:focus,select:focus{border-color:#334155;box-shadow:0 0 0 3px rgba(59,130,246,.2)}
    main{padding:14px;max-width:1200px;margin:0 auto}
    .grid{display:grid;gap:12px}
    @media(min-width:1024px){.grid{grid-template-columns: 1.05fr 1.6fr}}
    .card{background:linear-gradient(180deg,#0d1426,#0a0f1d);border:1px solid var(--border);
      border-radius:14px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .section-title{font-size:14px;color:var(--muted);margin:4px 0 8px;display:flex;align-items:center;gap:8px}
    .split{display:flex;gap:8px}.split>*{flex:1}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
    .list{display:flex;flex-direction:column;gap:8px;max-height:50vh;overflow:auto;padding-right:6px}
    .item{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px;
      display:flex;align-items:center;gap:10px;justify-content:space-between}
    .chip{background:var(--chip);color:var(--text);padding:6px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px}
    .muted{color:var(--muted);font-size:12px}
    .badge{font-size:11px;padding:3px 7px;border-radius:999px;border:1px solid var(--border);color:var(--muted)}
    .warning{display:none;background:#3a0c0c;border-bottom:1px solid #7f1d1d;color:#fecaca;padding:10px 12px}
    .warning.show{display:flex;align-items:center;gap:10px;justify-content:space-between}

    /* tabela */
    table{width:100%;border-collapse:separate;border-spacing:0 6px}
    th,td{padding:8px 10px;border-bottom:1px solid #0f172a;vertical-align:top}
    th{color:#cbd5e1;text-align:left;font-size:12px;text-transform:uppercase;letter-spacing:.04em}
    tr{background:#0d1426}
    tr td:first-child, tr th:first-child{border-top-left-radius:8px;border-bottom-left-radius:8px}
    tr td:last-child, tr th:last-child{border-top-right-radius:8px;border-bottom-right-radius:8px}

    /* mobilno */
    @media(max-width: 768px){
      .grid{grid-template-columns: 1fr}
      .toolbar{position:sticky;bottom:0;z-index:20;background:linear-gradient(180deg,#0a0f1d,#0b1220);
        border-top:1px solid var(--border);padding:10px;border-radius:12px}
      #shiftTable thead{display:none}
      #shiftTable, #shiftTable tbody, #shiftTable tr, #shiftTable td{display:block;width:100%}
      #shiftTable tr{border:1px solid var(--border);border-radius:12px;padding:10px;background:var(--card);margin-bottom:8px}
      #shiftTable td{border:none;padding:4px 0}
      #shiftTable td::before{content:attr(data-label) " "; display:block; font-size:11px; color:var(--muted); margin-bottom:2px}
      #shiftTable td.actions{display:flex;gap:6px;justify-content:flex-end}
      input,select,textarea,button{font-size:16px}
    }

    @media print{
      body{background:#fff;color:#000}
      header, .no-print{display:none !Important}
      table{border-spacing:0;border-collapse:collapse}
      th,td{border:1px solid #999;padding:6px}
      tr{background:#fff}
    }

    /* TEME */
    :root[data-theme="dark"]{
      --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#22c55e; --accent2:#3b82f6; --warn:#f59e0b; --danger:#ef4444;
      --chip:#1f2937; --card:#0b1220; --border:#1f2937;
    }
    :root[data-theme="light"]{
      --bg:#f5f6fa; --panel:#ffffff; --muted:#5b6577; --text:#10121a;
      --accent:#16a34a; --accent2:#2563eb; --warn:#b45309; --danger:#b91c1c;
      --chip:#edf0f7; --card:#ffffff; --border:#e5e7eb;
    }
    :root[data-theme="midnight"]{
      --bg:#0b1020; --panel:#0a0f1d; --muted:#8aa0bf; --text:#e8efff;
      --accent:#7c3aed; --accent2:#3b82f6; --warn:#f59e0b; --danger:#ef4444;
      --chip:#0f1a33; --card:#0b1228; --border:#142042;
    }
    :root[data-theme="forest"]{
      --bg:#0d1512; --panel:#0f1f19; --muted:#9bb2a3; --text:#e9f5ee;
      --accent:#22c55e; --accent2:#0ea5e9; --warn:#d97706; --danger:#dc2626;
      --chip:#123122; --card:#0e2018; --border:#1a3a2a;
    }
    :root[data-theme="amber"]{
      --bg:#1a1300; --panel:#1f1600; --muted:#e9d8a6; --text:#fff7cc;
      --accent:#f59e0b; --accent2:#fbbf24; --warn:#f97316; --danger:#ef4444;
      --chip:#2a2005; --card:#221a04; --border:#3a2b08;
    }
    :root[data-theme="corporate"]{
      --bg:#0e1626; --panel:#10182a; --muted:#aab4c6; --text:#f1f5fb;
      --accent:#2563eb; --accent2:#0ea5e9; --warn:#eab308; --danger:#ef4444;
      --chip:#152038; --card:#0f1930; --border:#1c2a4a;
    }
    :root[data-theme="contrast"]{
      --bg:#000; --panel:#000; --muted:#bbb; --text:#fff;
      --accent:#00ff5a; --accent2:#00b3ff; --warn:#ffd000; --danger:#ff4040;
      --chip:#111; --card:#000; --border:#333;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-top">
      <div class="title">Zoka</div>
      <div class="row no-print" style="gap:6px">
        <label class="chip" for="restoreInput" title="Učitaj backup">Učitaj backup<input id="restoreInput" type="file" accept="application/json" style="display:none"></label>
        <button id="btnBackup" class="primary">Preuzmi backup</button>
        <button id="btnShareBackup">Podeli backup</button>
        <button id="btnPrint">PDF (Štampa)</button>
        <button id="btnShareCSV">Podeli CSV</button>
      </div>
      <div class="row no-print" style="gap:6px; margin-left:auto">
        <label class="chip" for="themeSelect">Tema</label>
        <select id="themeSelect" style="min-width:160px">
          <option value="dark">Dark</option>
          <option value="light">Light</option>
          <option value="midnight">Midnight</option>
          <option value="forest">Forest</option>
          <option value="amber">Amber</option>
          <option value="corporate">Corporate</option>
          <option value="contrast">High Contrast</option>
        </select>
      </div>
    </div>
    <div class="tabs no-print">
      <div class="tab active" data-tab="events">Događaji</div>
      <div class="tab" data-tab="staff">Službenici</div>
      <div class="tab" data-tab="positions">Pozicije</div>
      <div class="tab" data-tab="shifts">Prisustvo</div>
    </div>
  </header>

  <div id="warn" class="warning">
    <div><b>Upozorenje:</b> Pregledač ne čuva podatke trajno. Otvori u Chrome/Safari ili koristi PWA. U međuvremenu klikni „Preuzmi backup“ da sačuvaš .json.</div>
    <div class="row">
      <button id="btnBackup2" class="danger">Preuzmi backup</button>
      <button id="btnShareBackup2">Podeli backup</button>
    </div>
  </div>

  <!-- DOGAĐAJI -->
  <main id="view-events" class="grid">
    <section class="card no-print">
      <div class="section-title">Događaji</div>
      <div class="row split">
        <input id="evName" placeholder="Naziv događaja" />
      </div>
      <div class="row split">
        <input id="evDateFrom" type="date" title="Datum od" />
        <input id="evDateTo" type="date" title="Datum do" />
      </div>
      <div class="row split">
        <input id="evResponsible" placeholder="Odgovorno lice (default: Zorica Mihajlović)" />
      </div>
      <div class="toolbar">
        <button class="success" id="btnAddEvent">Dodaj događaj</button>
        <button id="btnClearEvents" class="danger">Obriši sve događaje</button>
      </div>
      <div class="list" id="eventList"></div>
    </section>
    <section class="card">
      <div class="section-title">
        Trenutni događaj: <span id="currentEventLabel" class="badge">nema izabranog događaja</span>
      </div>
      <p class="muted">Izaberi događaj u levoj listi. U tabu <b>Prisustvo</b> unosiš i gledaš smene, sate i isplate.</p>
    </section>
  </main>

  <!-- SLUŽBENICI -->
  <main id="view-staff" class="grid" style="display:none">
    <section class="card">
      <div class="section-title">Službenici (direktorijum)</div>
      <div class="row split">
        <input id="staffName" placeholder="Ime i prezime" />
        <input id="staffDefaultRole" placeholder="Podrazumevana uloga (opciono)" />
      </div>
      <div class="toolbar">
        <button id="btnAddStaff" class="success">Dodaj službenika</button>
        <button id="btnImportStaff" class="ghost">Uvezi CSV</button>
        <button id="btnExportStaff" class="ghost">Izvezi CSV</button>
      </div>
      <input id="staffSearch" placeholder="Pretraga po imenu…" />
      <div class="list" id="staffList"></div>
    </section>
  </main>

  <!-- POZICIJE -->
  <main id="view-positions" class="grid" style="display:none">
    <section class="card">
      <div class="section-title">Pozicije (globalne)</div>
      <div class="row split">
        <input id="posName" placeholder="Naziv pozicije (npr. Ulaz A, Bina, Parking 2)" />
        <button id="btnAddPos" class="success">Dodaj poziciju</button>
      </div>
      <div id="posList" class="list"></div>
    </section>
  </main>

  <!-- PRISUSTVO / SMENE -->
  <main id="view-shifts" class="grid" style="display:none">
    <section class="card">
      <div class="section-title">Prisustvo (smene)</div>

      <!-- Izbor događaja unutar Prisustva -->
      <div class="row split no-print">
        <select id="eventSelect"></select>
        <div class="chip" id="eventInfo">Nije izabran događaj</div>
      </div>

      <div class="row split no-print" style="margin-top:6px">
        <select id="staffSelect" multiple size="3" title="Izaberi jednog ili više službenika"></select>
        <input id="guardRole" placeholder="Uloga (opciono)" />
      </div>
      <div class="row split no-print">
        <input id="shiftDate" type="date" />
        <select id="guardPosition"><option value="">— odaberi poziciju —</option></select>
      </div>
      <div class="row split no-print">
        <input id="timeFrom" type="time" />
        <input id="timeTo" type="time" />
      </div>

      <!-- Plaćanje -->
      <div class="row split no-print">
        <select id="payType">
          <option value="hourly">Plaćanje po satu</option>
          <option value="flat">Dnevnica (po smeni)</option>
        </select>
        <input id="payRate" type="number" step="0.01" min="0" placeholder="Iznos (RSD)" />
      </div>

      <div class="row split no-print">
        <select id="shiftStatus">
          <option value="Regularna">Regularna</option>
          <option value="Zamena">Zamena</option>
          <option value="Incident">Incident</option>
        </select>
        <input id="shiftNote" placeholder="Napomena (opciono)" />
      </div>

      <div class="toolbar no-print">
        <div class="row" style="gap:6px">
          <button id="tpl1" class="ghost small">07:00–15:00</button>
          <button id="tpl2" class="ghost small">15:00–23:00</button>
          <button id="tpl3" class="ghost small">23:00–07:00</button>
          <button id="btnEditTemplates" class="ghost small">Uredi šablone</button>
        </div>
        <button id="btnDupLast" class="ghost small">Dupliciraj poslednju</button>
        <button id="btnAddShift" class="success">Dodaj smenu (za izabrane)</button>
        <button id="btnExportCSV" class="primary right">Izvezi CSV</button>
      </div>

      <div id="shiftTableWrap">
        <table id="shiftTable">
          <thead>
            <tr>
              <th>Datum</th><th>Službenik</th><th>Pozicija</th><th>Uloga</th>
              <th>Od</th><th>Do</th><th>Sati</th>
              <th>Plaćanje</th><th>Iznos (RSD)</th>
              <th>Status</th><th>Napomena</th><th class="no-print"></th>
            </tr>
          </thead>
          <tbody id="shiftBody"></tbody>
        </table>
      </div>

      <!-- Rezimei -->
      <div class="card" style="margin-top:12px">
        <div class="section-title">Rezimei</div>
        <div id="summaryTotals" class="list"></div>
      </div>
    </section>
  </main>

  <script>
    /* Service Worker */
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js?v=81'));
    }

    /* Tema */
    const THEME_KEY = 'zoka_theme';
    const themeSelect = document.getElementById('themeSelect');
    function applyTheme(name){
      const root = document.documentElement;
      root.setAttribute('data-theme', name);
      try { localStorage.setItem(THEME_KEY, name); } catch(e){}
      const meta = document.querySelector('meta[name="theme-color"]');
      if(meta){
        const bg = getComputedStyle(root).getPropertyValue('--bg').trim() || '#0f172a';
        meta.setAttribute('content', bg);
      }
    }
    (function initTheme(){
      let t=null; try{ t=localStorage.getItem(THEME_KEY);}catch(e){}
      if(!t){ const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches; t = prefersLight?'light':'dark'; }
      applyTheme(t);
      if(themeSelect){ themeSelect.value=t; themeSelect.addEventListener('change', e=>applyTheme(e.target.value)); }
    })();

    /* ---------- storage & state ---------- */
    const LS_KEY = 'zoka_v81';
    let storageOK = true;
    try{ localStorage.setItem('__zoka_test','ok'); storageOK = localStorage.getItem('__zoka_test') === 'ok'; localStorage.removeItem('__zoka_test'); }catch(e){ storageOK=false; }
    const warn = document.getElementById('warn'); if(!storageOK){ warn.classList.add('show'); }

    function cryptoRandom(){ return Math.random().toString(36).slice(2,10)+Date.now().toString(36).slice(-4); }
    function defaultTemplates(){
      return [
        { id:'t1', label:'07:00–15:00', from:'07:00', to:'15:00' },
        { id:'t2', label:'15:00–23:00', from:'15:00', to:'23:00' },
        { id:'t3', label:'23:00–07:00', from:'23:00', to:'07:00' }
      ];
    }
    function loadRaw(){
      if(!storageOK) return { events:[], selectedEventId:null, staff:[], positions:[], templates:defaultTemplates() };
      const raw = localStorage.getItem(LS_KEY);
      if(raw){ try{ return JSON.parse(raw); }catch{} }
      return { events:[], selectedEventId:null, staff:[], positions:[], templates:defaultTemplates() };
    }
    function saveRaw(){ if(storageOK){ try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); }catch(e){} } }

    let state = loadRaw();

    /* ---------- helpers ---------- */
    const $ = s => document.querySelector(s);
    const el = (t,a={},...c)=>{ const n=document.createElement(t);
      for(const [k,v] of Object.entries(a)){
        if(k==='class') n.className=v;
        else if(k==='dataset'){ for(const [dk,dv] of Object.entries(v)) n.dataset[dk]=dv; }
        else if(k.startsWith('on') && typeof v==='function') n.addEventListener(k.slice(2),v);
        else if(v!==undefined && v!==null) n.setAttribute(k,v);
      }
      for(const x of c) n.append(x instanceof Node?x:document.createTextNode(x)); return n; };
    const minutes=(hhmm)=>{ const [h,m]=(hhmm||'').split(':').map(Number); if([h,m].some(x=>isNaN(x))) return null; return h*60+m; };
    const hoursDiff=(from,to)=>{ const a=minutes(from), b=minutes(to); if(a===null||b===null) return 0; let end=b; if(b<a) end+=1440; return Math.round(((end-a)/60)*100)/100; };
    const overlap=(from1,to1,from2,to2)=>{ const span=(f,t)=>{ let s=minutes(f), e=minutes(t); if(s===null||e===null) return null; if(e<s) e+=1440; return [s,e] }; const A=span(from1,to1), B=span(from2,to2); if(!A||!B) return false; return Math.max(A[0],B[0]) < Math.min(A[1],B[1]); };
    const moneyFmt = v => (Number(v||0)).toLocaleString('sr-RS', {minimumFractionDigits:2, maximumFractionDigits:2});
    const formatDate = d => d ? new Date(d).toLocaleDateString('sr-Latn-RS') : '';
    const formatRange = ev => { const a=formatDate(ev.dateFrom), b=formatDate(ev.dateTo); return (a&&b)?(a===b?a:`${a} – ${b}`):(a||b||''); };

    /* ---------- tabs ---------- */
    const tabs = document.querySelectorAll('.tab');
    const views = {
      events: $('#view-events'),
      staff: $('#view-staff'),
      positions: $('#view-positions'),
      shifts: $('#view-shifts')
    };
    tabs.forEach(t=>t.addEventListener('click', ()=>{
      tabs.forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const id = t.dataset.tab;
      Object.entries(views).forEach(([k,v])=> v.style.display = (k===id?'grid':'none'));
    }));

    /* ---------- backup/share/csv/pdf ---------- */
    function downloadBlob(data, name, type){
      const blob=new Blob([data],{type}); const a=document.createElement('a');
      a.href=URL.createObjectURL(blob); a.download=name; document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href),1000); return blob;
    }
    function backup(){ downloadBlob(JSON.stringify(state,null,2), `zoka_backup_${new Date().toISOString().slice(0,10)}.json`, 'application/json'); }
    $('#btnBackup').addEventListener('click', backup);
    const btnBackup2 = $('#btnBackup2'); if(btnBackup2) btnBackup2.addEventListener('click', backup);

    async function shareFile(name, blob, type){
      const file = new File([blob], name, {type});
      if(navigator.canShare && navigator.canShare({files:[file]})){
        try{ await navigator.share({ files:[file], title:'Zoka', text:'Deljenje fajla' }); }
        catch(e){ if(e?.name!=='AbortError') alert('Deljenje nije uspelo: '+e.message); }
      }else{
        downloadBlob(await blob.arrayBuffer(), name, type);
        alert('Fajl je sačuvan u Downloads – podeli ga ručno.');
      }
    }
    async function shareBackup(){
      const blob = new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
      await shareFile(`zoka_backup_${new Date().toISOString().slice(0,10)}.json`, blob, 'application/json');
    }
    $('#btnShareBackup').addEventListener('click', shareBackup);
    const btnShareBackup2 = $('#btnShareBackup2'); if(btnShareBackup2) btnShareBackup2.addEventListener('click', shareBackup);

    function makeCSV(){
      const ev = state.events.find(e=>e.id===state.selectedEventId);
      if(!ev) return {csv:'',name:'smene.csv'};
      const posMap = Object.fromEntries(state.positions.map(p=>[p.id,p.name]));
      const rows=[['Događaj','Period','Odgovorno lice','Datum smene','Službenik','Uloga','Pozicija','Od','Do','Sati','Plaćanje','Iznos (RSD)','Status','Napomena']];
      (ev.shifts||[]).forEach(s=>{
        rows.push([
          ev.name, formatRange(ev), ev.responsible||'',
          s.date||'', s.guard||'', s.role||'', posMap[s.posId]||'',
          s.from||'', s.to||'', (s.hours||0).toFixed(2),
          s.payType==='flat'?'Dnevnica':'Po satu',
          (s.amount||0).toFixed(2), s.status||'', s.note||''
        ]);
      });
      const csv = rows.map(r=>r.map(x=>{
        const s=(x??'').toString(); return (s.includes(';')||s.includes('"')||s.includes('\n')) ? '"'+s.replace(/"/g,'""')+'"' : s;
      }).join(';')).join('\n');
      const name = `smene_${(ev.name||'dogadjaj').replace(/\s+/g,'_')}.csv`;
      return {csv,name};
    }
    $('#btnExportCSV').addEventListener('click', ()=>{
      const {csv,name}=makeCSV(); if(!csv) return alert('Izaberi događaj.');
      downloadBlob(csv, name, 'text/csv;charset=utf-8;');
    });
    $('#btnShareCSV').addEventListener('click', async ()=>{
      const {csv,name}=makeCSV(); if(!csv) return alert('Izaberi događaj.');
      await shareFile(name, new Blob([csv],{type:'text/csv'}), 'text/csv');
    });

    function printPDF(){
      const ev = state.events.find(e=>e.id===state.selectedEventId);
      if(!ev) return alert('Izaberi događaj.');
      const posMap = Object.fromEntries(state.positions.map(p=>[p.id,p.name]));
      const rows=(ev.shifts||[]).slice().sort((a,b)=>{
        const d=(a.date||'').localeCompare(b.date||''); if(d!==0) return d;
        return (a.from||'').localeCompare(b.from||'');
      });
      const totalHours = rows.reduce((s,x)=>s+(x.hours||0),0);
      const totalAmount = rows.reduce((s,x)=>s+(x.amount||0),0);
      const win = window.open('', '_blank');
      const css = `<style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;padding:16px;color:#000;}
      h2{margin:0 0 8px} .muted{color:#555} table{width:100%;border-collapse:collapse}
      th,td{border:1px solid #999;padding:6px;text-align:left;vertical-align:top;font-size:12px}
      .sign{margin-top:20px;display:flex;gap:32px} .box{border:1px solid #999;padding:12px;min-height:80px;flex:1}
      .sum{margin-top:12px}</style>`;
      const head = `<h2>${ev.name||'Događaj'} – ${formatRange(ev)}</h2>
        <div class="muted">Odgovorno lice: ${ev.responsible||''}</div>
        <div class="sum"><b>Ukupno sati:</b> ${totalHours.toFixed(2)} • <b>Ukupan iznos:</b> ${moneyFmt(totalAmount)} RSD</div>`;
      const tableHead = `<table><thead><tr>
        <th>#</th><th>Datum</th><th>Službenik</th><th>Uloga</th><th>Pozicija</th><th>Od</th><th>Do</th><th>Sati</th><th>Plaćanje</th><th>Iznos</th><th>Status</th><th>Napomena</th>
        </tr></thead><tbody>`;
      const tableRows = rows.map((s,i)=>`<tr>
        <td>${i+1}</td><td>${s.date||''}</td><td>${s.guard||''}</td><td>${s.role||''}</td>
        <td>${posMap[s.posId]||''}</td><td>${s.from||''}</td><td>${s.to||''}</td>
        <td>${(s.hours||0).toFixed(2)}</td><td>${s.payType==='flat'?'Dnevnica':'Po satu'}</td>
        <td>${moneyFmt(s.amount||0)}</td><td>${s.status||''}</td><td>${s.note||''}</td></tr>`).join('');
      const foot = `</tbody></table><div class="sign">
        <div class="box">Šef smene:</div><div class="box">Nadzor/klijent:</div><div class="box">Odgovorno lice: ${ev.responsible||''}</div>
        </div>`;
      win.document.write(`<html><head><meta charset="UTF-8"><title>Štampa – ${ev.name||''}</title>${css}</head><body>${head}${tableHead}${tableRows}${foot}</body></html>`);
      win.document.close(); win.focus(); win.onload = ()=> win.print();
    }
    $('#btnPrint').addEventListener('click', printPDF);

    /* ---------- EVENTS ---------- */
    const eventList = $('#eventList');
    const currentEventLabel = $('#currentEventLabel');

    function renderEvents(){
      eventList.innerHTML='';
      const events = state.events.slice().sort((a,b)=> (a.dateFrom||'').localeCompare(b.dateFrom||''));
      if(events.length===0){ eventList.append(el('div',{class:'muted'},'Nema događaja. Dodaj prvi iznad.')); return; }
      for(const ev of events){
        const hrs=(ev.shifts||[]).reduce((s,x)=>s+(x.hours||0),0);
        const amt=(ev.shifts||[]).reduce((s,x)=>s+(x.amount||0),0);
        const isSel = ev.id===state.selectedEventId;
        eventList.append(
          el('div',{class:'item'},
            el('div',{},
              el('div',{}, ev.name||'Bez naziva'),
              el('div',{class:'muted'}, formatRange(ev) || '—'),
              el('div',{class:'muted'}, `Odgovorno: ${ev.responsible||''}`)
            ),
            el('div',{class:'row'},
              el('span',{class:'chip'}, `${(ev.shifts||[]).length} smena`),
              el('span',{class:'chip'}, `${hrs.toFixed(2)} h`),
              el('span',{class:'chip'}, `${moneyFmt(amt)} RSD`),
              el('button',{class:'ghost',onclick:()=>{ state.selectedEventId=ev.id; saveRaw(); renderAll(); }}, isSel?'Izabrano':'Otvori'),
              el('button',{class:'ghost',onclick:()=>delEvent(ev.id)}, 'Obriši')
            )
          )
        );
      }
    }
    function delEvent(id){
      if(!confirm('Obrisati događaj?')) return;
      state.events = state.events.filter(e=>e.id!==id);
      if(state.selectedEventId===id) state.selectedEventId = (state.events[0]?.id)||null;
      saveRaw(); renderAll();
    }
    document.getElementById('btnAddEvent').addEventListener('click', ()=>{
      const name = ($('#evName').value||'').trim();
      const df = $('#evDateFrom').value||'';
      const dt = $('#evDateTo').value||'';
      const resp = ($('#evResponsible').value||'').trim() || 'Zorica Mihajlović';
      if(!name) return alert('Unesi naziv događaja.');
      if(df && dt && df>dt) return alert('„Datum do“ ne može biti pre „Datum od“.');

      const ev = { id: cryptoRandom(), name, dateFrom: df||'', dateTo: dt||'', responsible: resp, shifts:[] };
      state.events.push(ev); state.selectedEventId = ev.id;
      $('#evName').value=''; $('#evDateFrom').value=''; $('#evDateTo').value=''; $('#evResponsible').value='';
      saveRaw(); renderAll(); updateEventSelect();
    });
    document.getElementById('btnClearEvents').addEventListener('click', ()=>{
      if(!confirm('Obrisati SVE događaje i podatke?')) return;
      state.events=[]; state.selectedEventId=null; saveRaw(); renderAll(); updateEventSelect();
    });

    /* ---------- STAFF ---------- */
    const staffList = $('#staffList');
    const staffSearch = $('#staffSearch');
    function renderStaff(){
      staffList.innerHTML='';
      const q = (staffSearch.value||'').toLowerCase();
      const items = state.staff
        .slice()
        .sort((a,b)=>a.name.localeCompare(b.name,'sr'))
        .filter(s=> s.name.toLowerCase().includes(q));
      if(items.length===0){ staffList.append(el('div',{class:'muted'}, 'Nema službenika. Dodaj iznad.')); return; }
      items.forEach(s=>{
        staffList.append(el('div',{class:'item'},
          el('div',{}, el('div',{}, s.name), el('div',{class:'muted'}, s.role||'—')),
          el('div',{class:'row'},
            el('button',{class:'ghost',onclick:()=>editStaff(s.id)},'Uredi'),
            el('button',{class:'ghost',onclick:()=>delStaff(s.id)},'Obriši')
          )
        ));
      });
    }
    function addStaff(){
      const name = ($('#staffName').value||'').trim(); if(!name) return alert('Unesi ime i prezime.');
      const role = ($('#staffDefaultRole').value||'').trim();
      state.staff.push({id:cryptoRandom(), name, role});
      $('#staffName').value=''; $('#staffDefaultRole').value='';
      saveRaw(); renderStaff(); renderShiftFormSources();
    }
    function delStaff(id){
      if(!confirm('Obrisati službenika iz direktorijuma? Ovo ne menja postojeće smene.')) return;
      state.staff = state.staff.filter(s=>s.id!==id);
      saveRaw(); renderStaff(); renderShiftFormSources();
    }
    function editStaff(id){
      const s = state.staff.find(x=>x.id===id); if(!s) return;
      const nn = prompt('Ime i prezime:', s.name); if(nn===null) return;
      const nr = prompt('Podrazumevana uloga (opciono):', s.role||''); if(nr===null) return;
      s.name=(nn||'').trim(); s.role=(nr||'').trim(); saveRaw(); renderStaff(); renderShiftFormSources();
    }
    document.getElementById('btnAddStaff').addEventListener('click', addStaff);
    staffSearch.addEventListener('input', renderStaff);

    // Staff CSV
    document.getElementById('btnExportStaff').addEventListener('click', ()=>{
      const rows=[['Ime i prezime','Uloga']];
      state.staff.forEach(s=> rows.push([s.name, s.role||'']));
      const csv = rows.map(r=>r.map(x=>{ const t=(x??'').toString(); return t.includes(',')?'"'+t.replace(/"/g,'""')+'"':t; }).join(',')).join('\n');
      downloadBlob(csv, 'sluzbenici.csv', 'text/csv');
    });
    document.getElementById('btnImportStaff').addEventListener('click', ()=>{
      const inp = document.createElement('input'); inp.type='file'; inp.accept='.csv,text/csv';
      inp.onchange = (e)=>{
        const f=e.target.files?.[0]; if(!f) return;
        const r=new FileReader(); r.onload=()=>{
          try{
            const lines = String(r.result).split(/\r?\n/).filter(Boolean);
            const start = lines[0].toLowerCase().includes('ime') ? 1 : 0;
            for(let i=start;i<lines.length;i++){
              const parts = lines[i].split(',').map(s=> s.replace(/^"|"$/g,'').replace(/""/g,'"').trim());
              if(!parts[0]) continue;
              state.staff.push({id:cryptoRandom(), name:parts[0], role:parts[1]||''});
            }
            saveRaw(); renderStaff(); renderShiftFormSources(); alert('Uvezeno.');
          }catch(err){ alert('Greška pri uvozu: '+err.message); }
        }; r.readAsText(f);
      };
      inp.click();
    });

    /* ---------- POSITIONS ---------- */
    const posList = $('#posList');
    function renderPositions(){
      posList.innerHTML='';
      const items = state.positions.slice().sort((a,b)=>a.name.localeCompare(b.name,'sr'));
      if(items.length===0){ posList.append(el('div',{class:'muted'},'Nema pozicija. Dodaj iznad.')); return; }
      items.forEach(p=>{
        posList.append(el('div',{class:'item'},
          el('div',{}, p.name),
          el('div',{class:'row'},
            el('button',{class:'ghost',onclick:()=>renamePos(p.id)},'Preimenuj'),
            el('button',{class:'ghost',onclick:()=>delPos(p.id)},'Obriši')
          )
        ));
      });
    }
    function addPos(){ const name = ($('#posName').value||'').trim(); if(!name) return;
      state.positions.push({id:cryptoRandom(), name}); $('#posName').value=''; saveRaw(); renderPositions(); renderShiftFormSources(); }
    function delPos(id){
      if(!confirm('Obrisati poziciju? Postojeće smene će ostati bez dodeljene pozicije.')) return;
      state.positions = state.positions.filter(p=>p.id!==id);
      state.events.forEach(ev=> (ev.shifts||[]).forEach(s=>{ if(s.posId===id) s.posId=''; }));
      saveRaw(); renderPositions(); renderShifts(); renderShiftFormSources();
    }
    function renamePos(id){
      const p = state.positions.find(x=>x.id===id); if(!p) return;
      const nn = prompt('Novi naziv pozicije:', p.name); if(!nn||!nn.trim()) return;
      p.name = nn.trim(); saveRaw(); renderPositions(); renderShiftFormSources(); renderShifts();
    }
    document.getElementById('btnAddPos').addEventListener('click', addPos);

    /* ---------- SHIFTS / PRISUSTVO ---------- */
    const eventSelect = document.getElementById('eventSelect');
    const eventInfo = document.getElementById('eventInfo');
    const shiftBody = document.getElementById('shiftBody');
    const staffSelect = document.getElementById('staffSelect');
    const positionSelect = document.getElementById('guardPosition');
    const shiftDate = document.getElementById('shiftDate');

    function renderEventInfoChip(){
      const ev = state.events.find(e=>e.id===state.selectedEventId);
      eventInfo.textContent = ev ? `${ev.name} • ${formatRange(ev)} • Odgovorno: ${ev.responsible||''}` : 'Nije izabran događaj';
    }
    function updateEventSelect(){
      eventSelect.innerHTML='';
      const opt = document.createElement('option');
      opt.value=''; opt.textContent='— izaberi događaj —';
      eventSelect.appendChild(opt);
      state.events.slice().sort((a,b)=> (a.dateFrom||'').localeCompare(b.dateFrom||'')).forEach(ev=>{
        const o = document.createElement('option');
        o.value = ev.id; o.textContent = `${ev.name} (${formatRange(ev)})`;
        eventSelect.appendChild(o);
      });
      eventSelect.value = state.selectedEventId || '';
      renderEventInfoChip();
    }
    eventSelect.addEventListener('change', ()=>{
      state.selectedEventId = eventSelect.value || null; saveRaw(); renderAll();
    });

    function renderShiftFormSources(){
      // staff
      staffSelect.innerHTML='';
      if(state.staff.length===0){
        staffSelect.append(el('option',{disabled:true},'Nema službenika – dodaj u tabu „Službenici“.'));
      }else{
        state.staff.slice().sort((a,b)=>a.name.localeCompare(b.name,'sr')).forEach(s=>{
          staffSelect.append(el('option',{value:s.id}, s.name));
        });
      }
      // positions
      positionSelect.innerHTML='<option value="">— odaberi poziciju —</option>';
      state.positions.slice().sort((a,b)=>a.name.localeCompare(b.name,'sr')).forEach(p=>{
        positionSelect.append(el('option',{value:p.id}, p.name));
      });

      // default datum u opsegu događaja
      const ev = state.events.find(e=>e.id===state.selectedEventId);
      shiftDate.value = ev ? (ev.dateFrom||'') : '';
    }

    function computeAmount(payType, rate, hours){
      const r = Number(rate||0);
      return payType==='flat' ? r : Math.max(0, (Number(hours||0) * r));
    }

    function renderShifts(){
      shiftBody.innerHTML='';
      const ev = state.events.find(e=>e.id===state.selectedEventId);
      if(!ev){
        currentEventLabel.textContent='nema izabranog događaja';
        renderEventInfoChip();
        shiftBody.append(el('tr',{}, el('td',{colspan:'12',class:'muted'},'Izaberi događaj u padajućoj listi iznad.')));
        document.getElementById('summaryTotals').innerHTML='';
        return;
      }
      currentEventLabel.textContent = `${ev.name} • ${formatRange(ev)}`;
      renderEventInfoChip();

      (ev.shifts||[]).forEach(s=>{
        s.hours = hoursDiff(s.from, s.to);
        s.amount = computeAmount(s.payType, s.rate, s.hours);
      });

      const posMap = Object.fromEntries(state.positions.map(p=>[p.id,p.name]));
      const rows = (ev.shifts||[]).slice().sort((a,b)=>{
        const d=(a.date||'').localeCompare(b.date||''); if(d!==0) return d;
        return (a.from||'').localeCompare(b.from||'');
      });
      if(rows.length===0) shiftBody.append(el('tr',{}, el('td',{colspan:'12',class:'muted'},'Nema smena. Dodaj iznad.')));
      rows.forEach(s=>{
        const tr = el('tr',{},
          el('td',{'data-label':'Datum'}, s.date||''),
          el('td',{'data-label':'Službenik'}, s.guard||''),
          el('td',{'data-label':'Pozicija'}, posMap[s.posId]||'—'),
          el('td',{'data-label':'Uloga'}, s.role||'—'),
          el('td',{'data-label':'Od'}, s.from||''),
          el('td',{'data-label':'Do'}, s.to||''),
          el('td',{'data-label':'Sati'}, (s.hours||0).toFixed(2)),
          el('td',{'data-label':'Plaćanje'}, s.payType==='flat'?'Dnevnica':'Po satu'),
          el('td',{'data-label':'Iznos (RSD)'}, moneyFmt(s.amount||0)),
          el('td',{'data-label':'Status'}, s.status||'Regularna'),
          el('td',{'data-label':'Napomena'}, s.note||'—'),
          (function(){ const td=el('td',{class:'actions no-print'});
            td.append(
              el('button',{class:'ghost small',onclick:()=>editShift(s.id)},'Uredi'),
              el('button',{class:'ghost small',onclick:()=>delShift(s.id)},'Obriši')
            ); return td; })()
        );
        shiftBody.append(tr);
      });

      renderSummaries(ev);
    }

    function renderSummaries(ev){
      const wrap = document.getElementById('summaryTotals'); wrap.innerHTML='';

      // Po danu
      const byDay = {};
      (ev.shifts||[]).forEach(s=>{
        const k = s.date||'—';
        byDay[k] = byDay[k]||{hours:0, amount:0};
        byDay[k].hours += (s.hours||0);
        byDay[k].amount += (s.amount||0);
      });
      wrap.append(el('div',{class:'item'},
        el('div',{}, el('div',{style:'font-weight:600'},'Zbir po danima')),
        el('div',{}, Object.entries(byDay).sort(([a],[b])=>a.localeCompare(b)).map(([d,v])=>`${d}: ${v.hours.toFixed(2)} h • ${moneyFmt(v.amount)} RSD`).join(' | '))
      ));

      // Po službeniku
      const byGuard = {};
      (ev.shifts||[]).forEach(s=>{
        const k = s.guard||'—';
        byGuard[k] = byGuard[k]||{hours:0, amount:0};
        byGuard[k].hours += (s.hours||0);
        byGuard[k].amount += (s.amount||0);
      });
      wrap.append(el('div',{class:'item'},
        el('div',{}, el('div',{style:'font-weight:600'},'Zbir po službeniku')),
        el('div',{}, Object.entries(byGuard).sort(([a],[b])=>a.localeCompare(b,'sr')).map(([g,v])=>`${g}: ${v.hours.toFixed(2)} h • ${moneyFmt(v.amount)} RSD`).join(' | '))
      ));

      // Ukupno
      const totalHours = (ev.shifts||[]).reduce((s,x)=>s+(x.hours||0),0);
      const totalAmount = (ev.shifts||[]).reduce((s,x)=>s+(x.amount||0),0);
      wrap.append(el('div',{class:'item'},
        el('div',{}, el('div',{style:'font-weight:600'},'Ukupno za događaj')),
        el('div',{}, `${totalHours.toFixed(2)} h • ${moneyFmt(totalAmount)} RSD`)
      ));
    }

    function addShiftBulk(fromDup=null){
      const ev = state.events.find(e=>e.id===state.selectedEventId);
      if(!ev) return alert('Izaberi događaj.');
      const date = fromDup?.date ?? document.getElementById('shiftDate').value || ev.dateFrom || '';
      const selectedStaffIds = Array.from(staffSelect.selectedOptions).map(o=>o.value);
      if(!fromDup && selectedStaffIds.length===0) return alert('Izaberi bar jednog službenika (Ctrl/duži tap za više).');

      const role = fromDup?.role ?? (document.getElementById('guardRole').value||'').trim();
      const posId = fromDup?.posId ?? (document.getElementById('guardPosition').value||'');
      const from  = fromDup?.from  ?? (document.getElementById('timeFrom').value||'');
      const to    = fromDup?.to    ?? (document.getElementById('timeTo').value||'');
      const payType = fromDup?.payType ?? (document.getElementById('payType').value||'hourly');
      const rate    = Number(fromDup?.rate ?? (document.getElementById('payRate').value||'0'));
      const status= fromDup?.status?? (document.getElementById('shiftStatus').value||'Regularna');
      const note  = fromDup?.note  ?? (document.getElementById('shiftNote').value||'');

      if(!date) return alert('Unesi datum smene.');
      if(!from || !to) return alert('Unesi vreme od–do.');
      const h = hoursDiff(from,to);
      const amount = computeAmount(payType, rate, h);

      const addOne = (guardName)=>{
        if(posId){
          const overl = (ev.shifts||[]).some(s=> s.posId===posId && s.date===date && overlap(s.from,s.to,from,to));
          if(overl && !confirm('Upozorenje: postoji preklapanje smena na istoj poziciji istog dana. Nastaviti?')) return;
        }
        ev.shifts.push({ id:cryptoRandom(), date, guard:guardName, role, posId, from, to, hours:h, status, note, payType, rate, amount });
      };

      if(fromDup){
        addOne(fromDup.guard);
      }else{
        selectedStaffIds.forEach(id=>{
          const st = state.staff.find(s=>s.id===id);
          addOne(st ? st.name : 'Nepoznat');
        });
      }
      saveRaw(); renderShifts();
      if(!fromDup){
        document.getElementById('shiftNote').value=''; document.getElementById('guardRole').value='';
      }
    }
    document.getElementById('btnAddShift').addEventListener('click', ()=>addShiftBulk());
    document.getElementById('btnDupLast').addEventListener('click', ()=>{
      const ev = state.events.find(e=>e.id===state.selectedEventId); if(!ev) return alert('Izaberi događaj.');
      const last = (ev.shifts||[]).slice(-1)[0]; if(!last) return alert('Nema prethodne smene.');
      addShiftBulk(last);
    });

    function delShift(id){
      const ev = state.events.find(e=>e.id===state.selectedEventId); if(!ev) return;
      ev.shifts = ev.shifts.filter(s=>s.id!==id); saveRaw(); renderShifts();
    }
    function editShift(id){
      const ev = state.events.find(e=>e.id===state.selectedEventId); if(!ev) return;
      const s = ev.shifts.find(x=>x.id===id); if(!s) return;

      const nd=prompt('Datum (YYYY-MM-DD):', s.date); if(nd===null) return;
      const ng=prompt('Službenik:', s.guard); if(ng===null) return;
      const nr=prompt('Uloga (opciono):', s.role||''); if(nr===null) return;
      const np=prompt('Pozicija (unesi tačan naziv, ili ostavi prazno):', (state.positions.find(p=>p.id===s.posId)?.name)||''); if(np===null) return;
      let pid=''; if(np){ const found = state.positions.find(p=>p.name===np); if(found) pid=found.id; }
      const nf=prompt('Od (hh:mm):', s.from); if(nf===null) return;
      const nt=prompt('Do (hh:mm):', s.to); if(nt===null) return;
      const npt=prompt('Plaćanje (hourly/flat):', s.payType||'hourly'); if(npt===null) return;
      const nr8=prompt('Iznos (RSD):', String(s.rate||0)); if(nr8===null) return;
      const ns=prompt('Status (Regularna/Zamena/Incident):', s.status||'Regularna'); if(ns===null) return;
      const nn=prompt('Napomena:', s.note||''); if(nn===null) return;

      s.date=(nd||'').trim(); s.guard=(ng||'').trim(); s.role=(nr||'').trim(); s.posId=pid;
      s.from=(nf||'').trim(); s.to=(nt||'').trim();
      s.payType=(npt==='flat'?'flat':'hourly'); s.rate=Number(nr8||0);
      s.status=(ns||'Regularna').trim(); s.note=(nn||'').trim();
      s.hours=hoursDiff(s.from,s.to); s.amount=computeAmount(s.payType,s.rate,s.hours);
      saveRaw(); renderShifts();
    }

    /* Šabloni */
    function applyTemplatesUI(){
      const map = Object.fromEntries((state.templates||defaultTemplates()).map(t=>[t.id,t]));
      const t1 = map['t1'], t2 = map['t2'], t3 = map['t3'];
      const b1=document.getElementById('tpl1'), b2=document.getElementById('tpl2'), b3=document.getElementById('tpl3');
      if(t1&&b1){ b1.textContent=t1.label; b1.onclick=()=>{ document.getElementById('timeFrom').value=t1.from; document.getElementById('timeTo').value=t1.to; }; }
      if(t2&&b2){ b2.textContent=t2.label; b2.onclick=()=>{ document.getElementById('timeFrom').value=t2.from; document.getElementById('timeTo').value=t2.to; }; }
      if(t3&&b3){ b3.textContent=t3.label; b3.onclick=()=>{ document.getElementById('timeFrom').value=t3.from; document.getElementById('timeTo').value=t3.to; }; }
    }
    document.getElementById('btnEditTemplates').addEventListener('click', ()=>{
      state.templates = state.templates || defaultTemplates();
      const map = Object.fromEntries(state.templates.map(t=>[t.id,t]));
      for(const k of ['t1','t2','t3']){
        const t = map[k] || {id:k,label:'',from:'',to:''};
        const nl = prompt(`Etiketa šablona (${k}):`, t.label || '');
        if(nl===null) continue;
        const nf = prompt('Vreme OD (hh:mm):', t.from || '');
        if(nf===null) continue;
        const nt = prompt('Vreme DO (hh:mm):', t.to || '');
        if(nt===null) continue;
        const idx = state.templates.findIndex(x=>x.id===k);
        const obj = {id:k,label:nl||`${nf}–${nt}`,from:nf||'',to:nt||''};
        if(idx>=0) state.templates[idx]=obj; else state.templates.push(obj);
      }
      saveRaw(); applyTemplatesUI();
    });

    /* Restore backup */
    document.getElementById('restoreInput').addEventListener('change',(e)=>{
      const f=e.target.files?.[0]; if(!f) return;
      const r=new FileReader(); r.onload=()=>{
        try{
          const obj=JSON.parse(r.result);
          if(!obj || !Array.isArray(obj.events) || !Array.isArray(obj.positions) || !Array.isArray(obj.staff)) throw new Error('Nevažeći fajl');
          obj.templates = obj.templates || defaultTemplates();
          state=obj; saveRaw(); renderAll(); updateEventSelect(); applyTemplatesUI(); alert('Backup učitan.');
        }catch(err){ alert('Greška: '+err.message); }
      }; r.readAsText(f);
    });

    /* Renderi */
    function renderAll(){
      const ev = state.events.find(e=>e.id===state.selectedEventId);
      currentEventLabel.textContent = ev ? `${ev.name} • ${formatRange(ev)}` : 'nema izabranog događaja';
      renderEvents();
      renderPositions();
      renderStaff();
      renderShiftFormSources();
      updateEventSelect();
      applyTemplatesUI();
      renderShifts();
    }

    // Init
    renderAll();
  </script>
</body>
</html>
