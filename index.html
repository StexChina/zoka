<!DOCTYPE html>
<html lang="sr-Latn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Zoka</title>
  <link rel="manifest" href="./manifest.webmanifest">
<meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <style>
    /* ===== minimalni stil (bez tema) ===== */
    :root{
      --bg:#f7f9fc; --panel:#ffffff; --text:#0b1020; --muted:#667085;
      --border:#e6e9ef; --accent:#2563eb; --ok:#16a34a; --danger:#dc2626;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;line-height:1.4}
    header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.9);
      border-bottom:1px solid var(--border);backdrop-filter:blur(8px)}
    .bar{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px 12px}
    .title{font-weight:700}
    .cmd{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .sep{width:1px;height:24px;background:var(--border)}
    button{border:1px solid var(--border);background:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
    button.primary{background:var(--accent);color:#fff;border-color:#1d4ed8}
    button.ok{background:var(--ok);color:#fff;border-color:#15803d}
    button.danger{background:var(--danger);color:#fff;border-color:#b91c1c}
    input,select,textarea{width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;background:#fff}
    main{padding:14px;max-width:1100px;margin:0 auto}
    .grid{display:grid;gap:12px}
    @media(min-width:960px){.grid{grid-template-columns:1.1fr 1.6fr}}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px}
    .section{font-size:13px;color:var(--muted);margin:2px 0 8px}
    .split{display:flex;gap:8px}.split>*{flex:1}
    .list{display:flex;flex-direction:column;gap:8px;max-height:52vh;overflow:auto}
    .item{display:flex;justify-content:space-between;gap:8px;align-items:center;border:1px solid var(--border);background:#fff;border-radius:10px;padding:8px}
    .muted{color:var(--muted);font-size:12px}
    .badge{display:inline-block;padding:3px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;color:var(--muted)}
    table{width:100%;border-collapse:separate;border-spacing:0 6px}
    th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top;background:#fff}
    th{font-size:12px;color:#374151;text-transform:uppercase;letter-spacing:.04em;background:#f2f5fb}
    tr td:first-child, tr th:first-child{border-top-left-radius:8px;border-bottom-left-radius:8px}
    tr td:last-child, tr th:last-child{border-top-right-radius:8px;border-bottom-right-radius:8px}
    .warning{display:none;background:#fff3cd;border-bottom:1px solid #ffe69c;color:#7a5d00;padding:10px 12px}
    .warning.show{display:flex;justify-content:space-between;align-items:center}
    @media(max-width: 760px){
      .grid{grid-template-columns:1fr}
      #shiftTable thead{display:none}
      #shiftTable, #shiftTable tbody, #shiftTable tr, #shiftTable td{display:block;width:100%}
      #shiftTable tr{padding:10px;border:1px solid var(--border);border-radius:10px;margin-bottom:8px;background:#fff}
      #shiftTable td{border:none;padding:6px 0}
      #shiftTable td::before{content:attr(data-label) " ";display:block;font-size:11px;color:var(--muted);margin-bottom:2px}
      .cmd{gap:6px}
    }
    @media print{
      header,.no-print{display:none !important}
      body{background:#fff;color:#000}
      th,td{border:1px solid #999;background:#fff}
      table{border-spacing:0;border-collapse:collapse}
    }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="title">Zoka</div>
      <div class="cmd no-print">
        <label for="restoreInput" style="border:1px solid var(--border);border-radius:8px;padding:6px 10px;cursor:pointer;background:#fff">Učitaj backup<input id="restoreInput" type="file" accept="application/json" style="display:none"></label>
        <button id="btnBackup" class="primary">Preuzmi backup</button>
        <button id="btnShareBackup">Podeli backup</button>
        <span class="sep"></span>
        <button id="btnPrint">PDF</button>
        <button id="btnShareCSV">Podeli CSV</button>
      </div>
    </div>
    <div class="bar" style="padding-top:0">
      <div class="cmd no-print" style="gap:8px">
        <button class="tabBtn" data-tab="events">Događaji</button>
        <button class="tabBtn" data-tab="staff">Službenici</button>
        <button class="tabBtn" data-tab="positions">Pozicije</button>
        <button class="tabBtn" data-tab="shifts">Prisustvo</button>
      </div>
      <span class="badge" id="currentEventLabel">nema izabranog događaja</span>
    </div>
  </header>

  <div id="warn" class="warning">
    <div><b>Napomena:</b> Ako pregledač briše podatke, koristi „Preuzmi backup“ i čuvaj .json fajl.</div>
    <div class="cmd">
      <button id="btnBackup2" class="danger">Preuzmi backup</button>
      <button id="btnShareBackup2">Podeli backup</button>
    </div>
  </div>

  <!-- DOGAĐAJI -->
  <main id="view-events" class="grid">
    <section class="card no-print">
      <div class="section">Događaji</div>
      <div class="split"><input id="evName" placeholder="Naziv događaja"></div>
      <div class="split">
        <input id="evDateFrom" type="date" title="Datum od">
        <input id="evDateTo" type="date" title="Datum do">
      </div>
      <div class="split"><input id="evResponsible" placeholder="Odgovorno lice (default: Zorica Mihajlović)"></div>
      <div class="cmd" style="margin:8px 0">
        <button id="btnAddEvent" class="ok">Dodaj događaj</button>
        <button id="btnClearEvents" class="danger">Obriši sve događaje</button>
      </div>
      <div id="eventList" class="list"></div>
    </section>
    <section class="card">
      <div class="section">Informacije</div>
      <p class="muted">Izaberi događaj u listi. U tabu <b>Prisustvo</b> vodiš smene, sate i isplate.</p>
    </section>
  </main>

  <!-- SLUŽBENICI -->
  <main id="view-staff" class="grid" style="display:none">
    <section class="card">
      <div class="section">Službenici</div>
      <div class="split">
        <input id="staffName" placeholder="Ime i prezime">
        <input id="staffDefaultRole" placeholder="Podrazumevana uloga (opciono)">
      </div>
      <div class="cmd" style="margin:8px 0">
        <button id="btnAddStaff" class="ok">Dodaj službenika</button>
        <button id="btnImportStaff">Uvezi CSV</button>
        <button id="btnExportStaff">Izvezi CSV</button>
      </div>
      <input id="staffSearch" placeholder="Pretraga po imenu…">
      <div id="staffList" class="list"></div>
    </section>
  </main>

  <!-- POZICIJE -->
  <main id="view-positions" class="grid" style="display:none">
    <section class="card">
      <div class="section">Pozicije</div>
      <div class="split">
        <input id="posName" placeholder="Naziv pozicije (npr. Ulaz A, Bina, Parking 2)">
        <button id="btnAddPos" class="ok">Dodaj poziciju</button>
      </div>
      <div id="posList" class="list"></div>
    </section>
  </main>

  <!-- PRISUSTVO -->
  <main id="view-shifts" class="grid" style="display:none">
    <section class="card">
      <div class="section">Prisustvo (smene)</div>

      <!-- izbor -->
      <div class="split no-print">
        <select id="eventSelect"></select>
        <div id="eventInfo" class="badge">Nije izabran događaj</div>
      </div>
      <div class="split no-print" style="margin-top:6px">
        <select id="staffSelect" multiple size="3" title="Izaberi jednog ili više službenika"></select>
        <input id="guardRole" placeholder="Uloga (opciono)">
      </div>
      <div class="split no-print">
        <input id="shiftDate" type="date">
        <select id="guardPosition"><option value="">— odaberi poziciju —</option></select>
      </div>

      <!-- šabloni -->
      <div class="card no-print" style="margin-top:8px">
        <div class="section">Brze smene (šabloni)</div>
        <div id="templateButtons" class="cmd"></div>
        <details id="tplEditor" style="margin-top:6px">
          <summary style="cursor:pointer">Uredi šablone</summary>
          <table style="width:100%;margin-top:8px">
            <thead><tr><th>Etiketa</th><th>Od</th><th>Do</th><th>Plaćanje</th><th>Iznos (RSD)</th><th></th></tr></thead>
            <tbody id="tplBody"></tbody>
          </table>
          <div class="cmd" style="margin-top:6px">
            <button id="btnAddTpl">Dodaj šablon</button>
            <button id="btnResetTpl">Vrati podrazumevane</button>
            <span class="muted">„Dnevnica“ ignoriše sate; „Po satu“ množi Iznos × sati.</span>
          </div>
        </details>
      </div>

      <!-- ručna korekcija -->
      <div class="split no-print">
        <input id="timeFrom" type="time" placeholder="Od">
        <input id="timeTo" type="time" placeholder="Do">
      </div>
      <div class="split no-print">
        <select id="payType">
          <option value="hourly">Plaćanje po satu</option>
          <option value="flat">Dnevnica (po smeni)</option>
        </select>
        <input id="payRate" type="number" step="0.01" min="0" placeholder="Iznos (RSD)">
      </div>
      <div class="split no-print">
        <select id="shiftStatus">
          <option value="Regularna">Regularna</option>
          <option value="Zamena">Zamena</option>
          <option value="Incident">Incident</option>
        </select>
        <input id="shiftNote" placeholder="Napomena (opciono)">
      </div>

      <div class="cmd no-print" style="margin:8px 0">
        <button id="btnDupLast">Dupliciraj poslednju</button>
        <button id="btnAddShift" class="ok">Dodaj smenu (za izabrane)</button>
        <button id="btnExportCSV" class="primary" style="margin-left:auto">Izvezi CSV</button>
      </div>

      <!-- tabela -->
      <div>
        <table id="shiftTable">
          <thead>
            <tr>
              <th>Datum</th><th>Službenik</th><th>Pozicija</th><th>Uloga</th>
              <th>Od</th><th>Do</th><th>Sati</th><th>Plaćanje</th><th>Iznos (RSD)</th><th>Status</th><th>Napomena</th><th class="no-print"></th>
            </tr>
          </thead>
          <tbody id="shiftBody"></tbody>
        </table>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="section">Rezimei</div>
        <div id="summaryTotals" class="list"></div>
      </div>
    </section>
  </main>

  <script>
  document.addEventListener('DOMContentLoaded', function(){
    /* ===== storage & state ===== */
    var LS='zoka_v84_min';
    var storageOK=true; try{ localStorage.setItem('__t','1'); localStorage.removeItem('__t'); }catch(e){ storageOK=false; }
    var warn=document.getElementById('warn'); if(!storageOK) warn.classList.add('show');

    function rand(){ return Math.random().toString(36).slice(2,9)+Date.now().toString(36).slice(-3); }
    function defTpl(){ return [
      {id:'t1',label:'07:00–15:00',from:'07:00',to:'15:00',payType:'hourly',rate:0},
      {id:'t2',label:'15:00–23:00',from:'15:00',to:'23:00',payType:'hourly',rate:0},
      {id:'t3',label:'23:00–07:00',from:'23:00',to:'07:00',payType:'hourly',rate:0},
      {id:'t4',label:'Događaj (dnevnica)',from:'',to:'',payType:'flat',rate:0}
    ]; }
    function load(){
      if(!storageOK) return {events:[],selectedEventId:null,staff:[],positions:[],templates:defTpl()};
      try{
        var raw=localStorage.getItem(LS);
        if(raw){ var o=JSON.parse(raw); if(!o.templates||!o.templates.length) o.templates=defTpl(); return o; }
      }catch(e){}
      return {events:[],selectedEventId:null,staff:[],positions:[],templates:defTpl()};
    }
    function save(){ if(storageOK) try{ localStorage.setItem(LS, JSON.stringify(state)); }catch(e){} }
    var state=load();

    /* ===== helpers ===== */
    function $(q){ return document.querySelector(q); }
    function el(t,a){ var n=document.createElement(t); if(a){ for(var k in a){
      if(k==='class') n.className=a[k];
      else if(k.indexOf('on')===0 && typeof a[k]==='function') n.addEventListener(k.slice(2),a[k]);
      else n.setAttribute(k,a[k]);
    }} for(var i=2;i<arguments.length;i++){ var c=arguments[i]; n.appendChild(c instanceof Node?c:document.createTextNode(String(c))); } return n; }
    function minutes(hhmm){ if(!hhmm) return null; var x=hhmm.split(':'); var h=+x[0],m=+x[1]; if(isNaN(h)||isNaN(m)) return null; return h*60+m; }
    function diffH(a,b){ var x=minutes(a), y=minutes(b); if(x==null||y==null) return 0; if(y<x) y+=1440; return Math.round((y-x)/6)/10; }
    function money(v){ var n=+v||0; try{return n.toLocaleString('sr-RS',{minimumFractionDigits:2,maximumFractionDigits:2});}catch(e){return n.toFixed(2);} }
    function datefmt(d){ try{return d?new Date(d).toLocaleDateString('sr-Latn-RS'):'';}catch(e){return d||'';} }
    function range(ev){ var a=datefmt(ev.dateFrom), b=datefmt(ev.dateTo); return (a&&b)?(a===b?a:(a+' – '+b)):(a||b||''); }

    /* ===== tabs ===== */
    var views={events:$('#view-events'),staff:$('#view-staff'),positions:$('#view-positions'),shifts:$('#view-shifts')};
    var tabBtns=document.querySelectorAll('.tabBtn');
    tabBtns.forEach(function(b){
      b.addEventListener('click', function(){
        var id=b.getAttribute('data-tab');
        Object.keys(views).forEach(function(k){ views[k].style.display = (k===id?'grid':'none'); });
      });
    });

    /* ===== backup / share / csv / pdf ===== */
    function download(data,name,type){ var blob=new Blob([data],{type:type}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); setTimeout(function(){ URL.revokeObjectURL(a.href); },500); return blob; }
    function backup(){ download(JSON.stringify(state,null,2),'zoka_backup_'+new Date().toISOString().slice(0,10)+'.json','application/json'); }
    $('#btnBackup').addEventListener('click',backup); $('#btnBackup2').addEventListener('click',backup);
    async function shareFile(name,blob,type){
      var f=new File([blob], name, {type:type});
      if(navigator.canShare && navigator.canShare({files:[f]})){ try{ await navigator.share({files:[f], title:'Zoka'});}catch(e){ if(!(e&&e.name==='AbortError')) alert('Deljenje nije uspelo.'); } }
      else{ download(await blob.arrayBuffer(),name,type); alert('Fajl je sačuvan. Podeli ručno.'); }
    }
    async function shareBackup(){ var b=new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); await shareFile('zoka_backup_'+new Date().toISOString().slice(0,10)+'.json',b,'application/json'); }
    $('#btnShareBackup').addEventListener('click',shareBackup); $('#btnShareBackup2').addEventListener('click',shareBackup);

    function makeCSV(){
      var ev=state.events.find(function(e){return e.id===state.selectedEventId;}); if(!ev) return {csv:'',name:''};
      var posMap={}; state.positions.forEach(function(p){posMap[p.id]=p.name;});
      var rows=[['Događaj','Period','Odgovorno lice','Datum','Službenik','Uloga','Pozicija','Od','Do','Sati','Plaćanje','Iznos (RSD)','Status','Napomena']];
      (ev.shifts||[]).forEach(function(s){
        rows.push([ev.name,range(ev),ev.responsible||'',s.date||'',s.guard||'',s.role||'',posMap[s.posId]||'',s.from||'',s.to||'',(s.hours||0).toFixed(2),s.payType==='flat'?'Dnevnica':'Po satu',(s.amount||0).toFixed(2),s.status||'',s.note||'']);
      });
      var csv=rows.map(function(r){return r.map(function(x){var s=(x==null?'':String(x)); return /[;"\n]/.test(s)?('"'+s.replace(/"/g,'""')+'"'):s;}).join(';');}).join('\n');
      return {csv:csv,name:'smene_'+(ev.name||'dogadjaj').replace(/\s+/g,'_')+'.csv'};
    }
    $('#btnExportCSV').addEventListener('click',function(){ var o=makeCSV(); if(!o.csv) return alert('Izaberi događaj.'); download(o.csv,o.name,'text/csv'); });
    $('#btnShareCSV').addEventListener('click',async function(){ var o=makeCSV(); if(!o.csv) return alert('Izaberi događaj.'); await shareFile(o.name,new Blob([o.csv],{type:'text/csv'}),'text/csv'); });

    function printPDF(){
      var ev=state.events.find(function(e){return e.id===state.selectedEventId;}); if(!ev) return alert('Izaberi događaj.');
      var posMap={}; state.positions.forEach(function(p){posMap[p.id]=p.name;});
      var rows=(ev.shifts||[]).slice().sort(function(a,b){var d=(a.date||'').localeCompare(b.date||''); if(d!==0) return d; return (a.from||'').localeCompare(b.from||'');});
      var totalH=rows.reduce(function(s,x){return s+(x.hours||0);},0);
      var totalA=rows.reduce(function(s,x){return s+(x.amount||0);},0);
      var w=window.open('','_blank'), css='<style>body{font-family:system-ui,Segoe UI,Arial;padding:16px} table{width:100%;border-collapse:collapse} th,td{border:1px solid #999;padding:6px;font-size:12px;text-align:left} .muted{color:#555}</style>';
      var head='<h2>'+ (ev.name||'Događaj') +' – '+range(ev)+'</h2><div class="muted">Odgovorno lice: '+(ev.responsible||'')+'</div><p><b>Ukupno sati:</b> '+totalH.toFixed(2)+' • <b>Ukupan iznos:</b> '+money(totalA)+' RSD</p>';
      var th='<table><thead><tr><th>#</th><th>Datum</th><th>Službenik</th><th>Uloga</th><th>Pozicija</th><th>Od</th><th>Do</th><th>Sati</th><th>Plaćanje</th><th>Iznos</th><th>Status</th><th>Napomena</th></tr></thead><tbody>';
      var tr=rows.map(function(s,i){return '<tr><td>'+(i+1)+'</td><td>'+ (s.date||'') +'</td><td>'+ (s.guard||'') +'</td><td>'+ (s.role||'') +'</td><td>'+ (posMap[s.posId]||'') +'</td><td>'+ (s.from||'') +'</td><td>'+ (s.to||'') +'</td><td>'+ (s.hours||0).toFixed(2) +'</td><td>'+ (s.payType==='flat'?'Dnevnica':'Po satu') +'</td><td>'+ money(s.amount||0) +'</td><td>'+ (s.status||'') +'</td><td>'+ (s.note||'') +'</td></tr>';}).join('');
      w.document.write('<html><head><meta charset="UTF-8"><title>Štampa</title>'+css+'</head><body>'+head+th+tr+'</tbody></table></body></html>'); w.document.close(); w.onload=function(){ w.print(); };
    }
    $('#btnPrint').addEventListener('click',printPDF);

    /* ===== events ===== */
    var eventList=$('#eventList'), currentEventLabel=$('#currentEventLabel');
    function renderEvents(){
      eventList.innerHTML='';
      var events=state.events.slice().sort(function(a,b){return (a.dateFrom||'').localeCompare(b.dateFrom||'');});
      if(!events.length){ eventList.appendChild(el('div',{class:'muted'},'Nema događaja.')); return; }
      events.forEach(function(ev){
        var hrs=(ev.shifts||[]).reduce(function(s,x){return s+(x.hours||0);},0);
        var amt=(ev.shifts||[]).reduce(function(s,x){return s+(x.amount||0);},0);
        eventList.appendChild(
          el('div',{class:'item'},
            el('div',{}, el('div',{}, ev.name||'Bez naziva'),
              el('div',{class:'muted'}, range(ev)||'—'),
              el('div',{class:'muted'}, 'Odgovorno: '+(ev.responsible||'')) ),
            el('div',{},
              el('span',{class:'badge'}, (ev.shifts||[]).length+' smena'),
              document.createTextNode(' '),
              el('span',{class:'badge'}, hrs.toFixed(2)+' h'),
              document.createTextNode(' '),
              el('span',{class:'badge'}, money(amt)+' RSD'),
              document.createTextNode(' '),
              el('button',{onclick:function(){state.selectedEventId=ev.id; save(); renderAll();}}, 'Otvori'),
              document.createTextNode(' '),
              el('button',{onclick:function(){delEvent(ev.id);}}, 'Obriši')
            )
          )
        );
      });
    }
    function delEvent(id){
      if(!confirm('Obrisati događaj?')) return;
      state.events=state.events.filter(function(e){return e.id!==id;});
      if(state.selectedEventId===id) state.selectedEventId = (state.events[0]&&state.events[0].id)||null;
      save(); renderAll();
    }
    $('#btnAddEvent').addEventListener('click',function(){
      var name=($('#evName').value||'').trim();
      var df=$('#evDateFrom').value||'', dt=$('#evDateTo').value||'';
      var resp=($('#evResponsible').value||'').trim() || 'Zorica Mihajlović';
      if(!name) return alert('Unesi naziv događaja.');
      if(df && dt && df>dt) return alert('„Datum do“ ne može biti pre „Datum od“.');
      var ev={id:rand(),name:name,dateFrom:df,dateTo:dt,responsible:resp,shifts:[]};
      state.events.push(ev); state.selectedEventId=ev.id;
      $('#evName').value=''; $('#evDateFrom').value=''; $('#evDateTo').value=''; $('#evResponsible').value='';
      save(); renderAll(); updateEventSelect();
    });
    $('#btnClearEvents').addEventListener('click',function(){
      if(!confirm('Obrisati SVE događaje?')) return;
      state.events=[]; state.selectedEventId=null; save(); renderAll(); updateEventSelect();
    });

    /* ===== staff ===== */
    var staffList=$('#staffList'), staffSearch=$('#staffSearch');
    function renderStaff(){
      staffList.innerHTML='';
      var q=(staffSearch.value||'').toLowerCase();
      var items=state.staff.slice().sort(function(a,b){return a.name.localeCompare(b.name,'sr');}).filter(function(s){return (s.name||'').toLowerCase().indexOf(q)>-1;});
      if(!items.length){ staffList.appendChild(el('div',{class:'muted'},'Nema službenika.')); return; }
      items.forEach(function(s){
        staffList.appendChild(el('div',{class:'item'},
          el('div',{}, el('div',{}, s.name), el('div',{class:'muted'}, s.role||'—')),
          el('div',{}, el('button',{onclick:function(){editStaff(s.id);}},'Uredi'), ' ', el('button',{onclick:function(){delStaff(s.id);}},'Obriši'))
        ));
      });
    }
    function addStaff(){
      var name=($('#staffName').value||'').trim(); if(!name) return alert('Unesi ime i prezime.');
      var role=($('#staffDefaultRole').value||'').trim();
      state.staff.push({id:rand(),name:name,role:role});
      $('#staffName').value=''; $('#staffDefaultRole').value=''; save(); renderStaff(); renderShiftFormSources();
    }
    function delStaff(id){
      if(!confirm('Obrisati službenika iz direktorijuma?')) return;
      state.staff=state.staff.filter(function(s){return s.id!==id;}); save(); renderStaff(); renderShiftFormSources();
    }
    function editStaff(id){
      var s=state.staff.find(function(x){return x.id===id;}); if(!s) return;
      var nn=prompt('Ime i prezime:', s.name); if(nn===null) return;
      var nr=prompt('Podrazumevana uloga:', s.role||''); if(nr===null) return;
      s.name=(nn||'').trim(); s.role=(nr||'').trim(); save(); renderStaff(); renderShiftFormSources();
    }
    $('#btnAddStaff').addEventListener('click',addStaff);
    staffSearch.addEventListener('input',renderStaff);
    $('#btnExportStaff').addEventListener('click',function(){
      var rows=[['Ime i prezime','Uloga']]; state.staff.forEach(function(s){rows.push([s.name,s.role||'']);});
      var csv=rows.map(function(r){return r.join(',');}).join('\n'); download(csv,'sluzbenici.csv','text/csv');
    });
    $('#btnImportStaff').addEventListener('click',function(){
      var inp=document.createElement('input'); inp.type='file'; inp.accept='.csv,text/csv';
      inp.onchange=function(e){
        var f=e.target.files&&e.target.files[0]; if(!f) return;
        var r=new FileReader(); r.onload=function(){
          var lines=String(r.result).split(/\r?\n/).filter(Boolean);
          var start=(lines[0]||'').toLowerCase().includes('ime')?1:0;
          for(var i=start;i<lines.length;i++){ var p=lines[i].split(','); if(p[0]) state.staff.push({id:rand(),name:p[0].trim(),role:(p[1]||'').trim()}); }
          save(); renderStaff(); renderShiftFormSources(); alert('Uvezeno.');
        }; r.readAsText(f);
      }; inp.click();
    });

    /* ===== positions ===== */
    var posList=$('#posList');
    function renderPositions(){
      posList.innerHTML='';
      var items=state.positions.slice().sort(function(a,b){return a.name.localeCompare(b.name,'sr');});
      if(!items.length){ posList.appendChild(el('div',{class:'muted'},'Nema pozicija.')); return; }
      items.forEach(function(p){
        posList.appendChild(el('div',{class:'item'},
          el('div',{}, p.name),
          el('div',{}, el('button',{onclick:function(){renamePos(p.id);}},'Preimenuj'), ' ', el('button',{onclick:function(){delPos(p.id);}},'Obriši'))
        ));
      });
    }
    function addPos(){ var n=($('#posName').value||'').trim(); if(!n) return; state.positions.push({id:rand(),name:n}); $('#posName').value=''; save(); renderPositions(); renderShiftFormSources(); }
    function delPos(id){
      if(!confirm('Obrisati poziciju?')) return;
      state.positions=state.positions.filter(function(p){return p.id!==id;});
      state.events.forEach(function(ev){ (ev.shifts||[]).forEach(function(s){ if(s.posId===id) s.posId=''; }); });
      save(); renderPositions(); renderShifts(); renderShiftFormSources();
    }
    function renamePos(id){ var p=state.positions.find(function(x){return x.id===id;}); if(!p) return; var nn=prompt('Novi naziv pozicije:', p.name); if(!nn) return; p.name=nn.trim(); save(); renderPositions(); renderShiftFormSources(); renderShifts(); }
    $('#btnAddPos').addEventListener('click',addPos);

    /* ===== shifts ===== */
    var eventSelect=$('#eventSelect'), eventInfo=$('#eventInfo'), shiftBody=$('#shiftBody'), staffSelect=$('#staffSelect'), positionSelect=$('#guardPosition'), shiftDate=$('#shiftDate');
    function renderEventInfo(){ var ev=state.events.find(function(e){return e.id===state.selectedEventId;}); eventInfo.textContent=ev? (ev.name+' • '+range(ev)+' • Odgovorno: '+(ev.responsible||'')) : 'Nije izabran događaj'; }
    function updateEventSelect(){
      eventSelect.innerHTML=''; var opt=el('option',{},'— izaberi događaj —'); opt.value=''; eventSelect.appendChild(opt);
      state.events.slice().sort(function(a,b){return (a.dateFrom||'').localeCompare(b.dateFrom||'');})
        .forEach(function(ev){ var o=el('option',{}, ev.name+' ('+range(ev)+')'); o.value=ev.id; eventSelect.appendChild(o); });
      eventSelect.value=state.selectedEventId||''; renderEventInfo();
    }
    eventSelect.addEventListener('change',function(){ state.selectedEventId=eventSelect.value||null; save(); renderAll(); });

    function renderShiftFormSources(){
      staffSelect.innerHTML='';
      if(!state.staff.length){ var o=el('option',{},'Nema službenika – dodaj u tabu „Službenici“.'); o.disabled=true; staffSelect.appendChild(o); }
      else{ state.staff.slice().sort(function(a,b){return a.name.localeCompare(b.name,'sr');}).forEach(function(s){ var o=el('option',{},s.name); o.value=s.id; staffSelect.appendChild(o); }); }
      positionSelect.innerHTML='<option value="">— odaberi poziciju —</option>';
      state.positions.slice().sort(function(a,b){return a.name.localeCompare(b.name,'sr');}).forEach(function(p){ var o=el('option',{},p.name); o.value=p.id; positionSelect.appendChild(o); });
      var ev=state.events.find(function(e){return e.id===state.selectedEventId;}); shiftDate.value=ev?(ev.dateFrom||''):'';
    }

    function computeAmount(type,rate,h){ rate=+rate||0; return type==='flat'? rate : Math.max(0,h*rate); }

    function renderShifts(){
      shiftBody.innerHTML='';
      var ev=state.events.find(function(e){return e.id===state.selectedEventId;});
      var currentEventLabel=$('#currentEventLabel'); currentEventLabel.textContent = ev? (ev.name+' • '+range(ev)) : 'nema izabranog događaja';
      renderEventInfo();
      if(!ev){ shiftBody.appendChild(el('tr',{}, el('td',{colspan:'12'},'Izaberi događaj.'))); $('#summaryTotals').innerHTML=''; return; }

      (ev.shifts||[]).forEach(function(s){ s.hours=diffH(s.from,s.to); s.amount=computeAmount(s.payType,s.rate,s.hours); });
      var posMap={}; state.positions.forEach(function(p){posMap[p.id]=p.name;});
      var rows=(ev.shifts||[]).slice().sort(function(a,b){var d=(a.date||'').localeCompare(b.date||''); if(d!==0) return d; return (a.from||'').localeCompare(b.from||'');});
      if(!rows.length){ shiftBody.appendChild(el('tr',{}, el('td',{colspan:'12'},'Nema smena.'))); }
      rows.forEach(function(s){
        shiftBody.appendChild(el('tr',{},
          el('td',{'data-label':'Datum'}, s.date||''), el('td',{'data-label':'Službenik'}, s.guard||''),
          el('td',{'data-label':'Pozicija'}, posMap[s.posId]||'—'), el('td',{'data-label':'Uloga'}, s.role||'—'),
          el('td',{'data-label':'Od'}, s.from||''), el('td',{'data-label':'Do'}, s.to||''), el('td',{'data-label':'Sati'}, (s.hours||0).toFixed(2)),
          el('td',{'data-label':'Plaćanje'}, s.payType==='flat'?'Dnevnica':'Po satu'),
          el('td',{'data-label':'Iznos (RSD)'}, money(s.amount||0)),
          el('td',{'data-label':'Status'}, s.status||'Regularna'),
          el('td',{'data-label':'Napomena'}, s.note||'—'),
          (function(){var td=el('td',{}); td.appendChild(el('button',{onclick:function(){editShift(s.id);}},'Uredi')); td.appendChild(document.createTextNode(' ')); td.appendChild(el('button',{onclick:function(){delShift(s.id);}},'Obriši')); return td;})()
        ));
      });

      // rezimei
      var wrap=$('#summaryTotals'); wrap.innerHTML='';
      var byDay={}, byGuard={}; rows.forEach(function(s){
        var d=s.date||'—'; if(!byDay[d]) byDay[d]={h:0,a:0}; byDay[d].h+=s.hours||0; byDay[d].a+=s.amount||0;
        var g=s.guard||'—'; if(!byGuard[g]) byGuard[g]={h:0,a:0}; byGuard[g].h+=s.hours||0; byGuard[g].a+=s.amount||0;
      });
      var dayLine=Object.keys(byDay).sort().map(function(d){var v=byDay[d]; return d+': '+v.h.toFixed(2)+' h • '+money(v.a)+' RSD';}).join(' | ');
      var guardLine=Object.keys(byGuard).sort(function(a,b){return a.localeCompare(b,'sr');}).map(function(g){var v=byGuard[g]; return g+': '+v.h.toFixed(2)+' h • '+money(v.a)+' RSD';}).join(' | ');
      var totalH=rows.reduce(function(s,x){return s+(x.hours||0);},0), totalA=rows.reduce(function(s,x){return s+(x.amount||0);},0);
      wrap.appendChild(el('div',{class:'item'}, el('div',{},'Zbir po danima'), el('div',{},dayLine||'—')));
      wrap.appendChild(el('div',{class:'item'}, el('div',{},'Zbir po službeniku'), el('div',{},guardLine||'—')));
      wrap.appendChild(el('div',{class:'item'}, el('div',{},'Ukupno za događaj'), el('div',{}, totalH.toFixed(2)+' h • '+money(totalA)+' RSD')));
    }

    function addShiftBulk(fromDup){
      var ev=state.events.find(function(e){return e.id===state.selectedEventId;}); if(!ev) return alert('Izaberi događaj.');
      var date= fromDup? fromDup.date : ($('#shiftDate').value || ev.dateFrom || '');
      var selectedIds = fromDup? [] : Array.from(staffSelect.selectedOptions||[]).map(function(o){return o.value;});
      if(!fromDup && !selectedIds.length) return alert('Izaberi bar jednog službenika.');
      var role = fromDup? fromDup.role : ($('#guardRole').value||'').trim();
      var posId= fromDup? fromDup.posId : ($('#guardPosition').value||'');
      var from = fromDup? fromDup.from  : ($('#timeFrom').value||'');
      var to   = fromDup? fromDup.to    : ($('#timeTo').value||'');
      var payT = fromDup? fromDup.payType : ($('#payType').value||'hourly');
      var rate = fromDup? (+fromDup.rate||0) : (+($('#payRate').value||0));
      var status = fromDup? fromDup.status : ($('#shiftStatus').value||'Regularna');
      var note = fromDup? fromDup.note : ($('#shiftNote').value||'');
      if(!date) return alert('Unesi datum.');
      if(payT!=='flat' && (!from||!to)) return alert('Unesi vreme od–do ili koristi „Dnevnica“.');

      function pushOne(name){
        var hours = (payT==='flat')? 0 : diffH(from,to);
        var amount = computeAmount(payT,rate,hours);
        ev.shifts.push({id:rand(),date:date,guard:name,role:role,posId:posId,from:from,to:to,hours:hours,status:status,note:note,payType:payT,rate:rate,amount:amount});
      }
      if(fromDup){ pushOne(fromDup.guard); }
      else{
        selectedIds.forEach(function(id){ var st=state.staff.find(function(s){return s.id===id;}); pushOne(st?st.name:'Nepoznat'); });
      }
      save(); renderShifts();
      if(!fromDup){ $('#shiftNote').value=''; $('#guardRole').value=''; }
    }
    $('#btnAddShift').addEventListener('click',function(){ addShiftBulk(null); });
    $('#btnDupLast').addEventListener('click',function(){
      var ev=state.events.find(function(e){return e.id===state.selectedEventId;}); if(!ev) return alert('Izaberi događaj.');
      var last=(ev.shifts||[]).slice(-1)[0]; if(!last) return alert('Nema prethodne smene.'); addShiftBulk(last);
    });
    function delShift(id){ var ev=state.events.find(function(e){return e.id===state.selectedEventId;}); if(!ev) return; ev.shifts=ev.shifts.filter(function(s){return s.id!==id;}); save(); renderShifts(); }
    function editShift(id){
      var ev=state.events.find(function(e){return e.id===state.selectedEventId;}); if(!ev) return;
      var s=(ev.shifts||[]).find(function(x){return x.id===id;}); if(!s) return;
      var nd=prompt('Datum (YYYY-MM-DD):', s.date); if(nd===null) return;
      var ng=prompt('Službenik:', s.guard); if(ng===null) return;
      var nr=prompt('Uloga:', s.role||''); if(nr===null) return;
      var np=prompt('Pozicija (tačan naziv ili prazno):', (state.positions.find(function(p){return p.id===s.posId;})||{}).name||''); if(np===null) return;
      var pid=''; if(np){ var fp=state.positions.find(function(p){return p.name===np;}); if(fp) pid=fp.id; }
      var nf=prompt('Od (hh:mm):', s.from||''); if(nf===null) return;
      var nt=prompt('Do (hh:mm):', s.to||''); if(nt===null) return;
      var npt=prompt('Plaćanje (hourly/flat):', s.payType||'hourly'); if(npt===null) return;
      var nr8=prompt('Iznos (RSD):', String(s.rate||0)); if(nr8===null) return;
      var ns=prompt('Status:', s.status||'Regularna'); if(ns===null) return;
      var nn=prompt('Napomena:', s.note||''); if(nn===null) return;
      s.date=(nd||'').trim(); s.guard=(ng||'').trim(); s.role=(nr||'').trim(); s.posId=pid;
      s.from=(nf||'').trim(); s.to=(nt||'').trim(); s.payType=(npt==='flat'?'flat':'hourly'); s.rate=+(nr8||0);
      s.status=(ns||'Regularna').trim(); s.note=(nn||'').trim();
      s.hours=diffH(s.from,s.to); s.amount=computeAmount(s.payType,s.rate,s.hours);
      save(); renderShifts();
    }

    /* ===== templates (inline uvek editabilno) ===== */
    var tplBody=$('#tplBody'), tplButtons=$('#templateButtons');
    function renderTpl(){
      tplBody.innerHTML=''; tplButtons.innerHTML='';
      state.templates.forEach(function(t){
        // dugmad
        tplButtons.appendChild(el('button',{onclick:function(){
          $('#timeFrom').value=t.from||''; $('#timeTo').value=t.to||'';
          $('#payType').value=t.payType||'hourly'; $('#payRate').value=t.rate||0;
        }}, t.label));

        // editor tabela
        var tr=el('tr',{},
          el('td',{}, (function(){var i=el('input',{value:t.label}); i.addEventListener('input',function(){ t.label=this.value; save(); renderTpl(); }); return i; })()),
          el('td',{}, (function(){var i=el('input',{value:t.from, type:'time'}); i.addEventListener('input',function(){ t.from=this.value; save(); }); return i; })()),
          el('td',{}, (function(){var i=el('input',{value:t.to, type:'time'}); i.addEventListener('input',function(){ t.to=this.value; save(); }); return i; })()),
          el('td',{}, (function(){var s=el('select',{}); ['hourly','flat'].forEach(function(v){ var o=el('option',{}, v==='hourly'?'Po satu':'Dnevnica'); o.value=v; if(v===t.payType) o.selected=true; s.appendChild(o); });
            s.addEventListener('change',function(){ t.payType=this.value; save(); }); return s; })()),
          el('td',{}, (function(){var i=el('input',{type:'number',step:'0.01',min:'0',value:t.rate||0}); i.addEventListener('input',function(){ t.rate=+this.value||0; save(); }); return i; })()),
          el('td',{}, el('button',{onclick:function(){ removeTpl(t.id); }}, 'Ukloni'))
        );
        tplBody.appendChild(tr);
      });
    }
    function removeTpl(id){ state.templates=state.templates.filter(function(x){return x.id!==id;}); save(); renderTpl(); }
    $('#btnAddTpl').addEventListener('click',function(){ state.templates.push({id:rand(),label:'Nova smena',from:'',to:'',payType:'hourly',rate:0}); save(); renderTpl(); });
    $('#btnResetTpl').addEventListener('click',function(){ if(!confirm('Vrati podrazumevane šablone?')) return; state.templates=defTpl(); save(); renderTpl(); });

    /* ===== restore backup ===== */
    $('#restoreInput').addEventListener('change',function(e){
      var f=e.target.files&&e.target.files[0]; if(!f) return;
      var r=new FileReader(); r.onload=function(){
        try{
          var o=JSON.parse(r.result); if(!o||!o.events||!o.positions||!o.staff) throw new Error('Nevažeći fajl');
          o.templates=o.templates&&o.templates.length?o.templates:defTpl(); state=o; save(); renderAll(); updateEventSelect(); renderTpl(); alert('Backup učitan.');
        }catch(err){ alert('Greška: '+err.message); }
      }; r.readAsText(f);
    });

    /* ===== render all ===== */
    function renderAll(){
      var ev=state.events.find(function(e){return e.id===state.selectedEventId;});
      $('#currentEventLabel').textContent = ev? (ev.name+' • '+range(ev)) : 'nema izabranog događaja';
      renderEvents(); renderPositions(); renderStaff(); renderShiftFormSources(); updateEventSelect(); renderTpl(); renderShifts();
    }

    // init
    renderAll();
  });
  </script>
  <script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}
</script>
</body>
</html>
