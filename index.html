<!DOCTYPE html>
<html lang="sr-Latn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Zoka</title>
  <meta name="theme-color" content="#0f172a"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="manifest" href="./manifest.webmanifest?v=82">
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#22c55e; --accent2:#3b82f6; --warn:#f59e0b; --danger:#ef4444;
      --chip:#1f2937; --card:#0b1220; --border:#1f2937;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial;line-height:1.35}

    header{position:sticky;top:0;z-index:30;backdrop-filter:saturate(1.2) blur(8px);
      background:rgba(11,17,32,.9);border-bottom:1px solid var(--border);
      padding:10px 12px}
    .header-top{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .title{font-weight:700;letter-spacing:.2px;font-size:18px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .tabs{display:flex;gap:8px;align-items:center;margin-top:8px}
    .tab{padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:#0d1426;cursor:pointer;color:#cbd5e1}
    .tab.active{background:#1f2937;color:#fff;border-color:#334155}

    button{border:1px solid var(--border);background:#121a2f;color:var(--text);padding:10px 12px;border-radius:10px;cursor:pointer}
    button.primary{background:linear-gradient(180deg,var(--accent2), #1d4ed8);border-color:#1e40af}
    button.success{background:linear-gradient(180deg,var(--accent), #16a34a);border-color:#15803d}
    button.warn{background:linear-gradient(180deg,var(--warn), #b45309);border-color:#b45309}
    button.danger{background:linear-gradient(180deg,var(--danger), #dc2626);border-color:#b91c1c}
    button.ghost{background:#0b122000}
    button:active{transform:translateY(1px)}
    input,select,textarea{background:#0b1220;color:var(--text);border:1px solid var(--border);
      padding:12px;border-radius:10px;outline:none;width:100%}
    input:focus,textarea:focus,select:focus{border-color:#334155;box-shadow:0 0 0 3px rgba(59,130,246,.2)}
    main{padding:14px;max-width:1200px;margin:0 auto}
    .grid{display:grid;gap:12px}
    @media(min-width:1024px){.grid{grid-template-columns: 1.05fr 1.6fr}}
    .card{background:linear-gradient(180deg,#0d1426,#0a0f1d);border:1px solid var(--border);
      border-radius:14px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .section-title{font-size:14px;color:var(--muted);margin:4px 0 8px;display:flex;align-items:center;gap:8px}
    .split{display:flex;gap:8px}.split>*{flex:1}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
    .list{display:flex;flex-direction:column;gap:8px;max-height:50vh;overflow:auto;padding-right:6px}
    .item{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px;
      display:flex;align-items:center;gap:10px;justify-content:space-between}
    .chip{background:var(--chip);color:var(--text);padding:6px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px}
    .muted{color:var(--muted);font-size:12px}
    .badge{font-size:11px;padding:3px 7px;border-radius:999px;border:1px solid var(--border);color:var(--muted)}
    .warning{display:none;background:#3a0c0c;border-bottom:1px solid #7f1d1d;color:#fecaca;padding:10px 12px}
    .warning.show{display:flex;align-items:center;gap:10px;justify-content:space-between}

    table{width:100%;border-collapse:separate;border-spacing:0 6px}
    th,td{padding:8px 10px;border-bottom:1px solid #0f172a;vertical-align:top}
    th{color:#cbd5e1;text-align:left;font-size:12px;text-transform:uppercase;letter-spacing:.04em}
    tr{background:#0d1426}
    tr td:first-child, tr th:first-child{border-top-left-radius:8px;border-bottom-left-radius:8px}
    tr td:last-child, tr th:last-child{border-top-right-radius:8px;border-bottom-right-radius:8px}

    @media(max-width: 768px){
      .grid{grid-template-columns: 1fr}
      .toolbar{position:sticky;bottom:0;z-index:20;background:linear-gradient(180deg,#0a0f1d,#0b1220);
        border-top:1px solid var(--border);padding:10px;border-radius:12px}
      #shiftTable thead{display:none}
      #shiftTable, #shiftTable tbody, #shiftTable tr, #shiftTable td{display:block;width:100%}
      #shiftTable tr{border:1px solid var(--border);border-radius:12px;padding:10px;background:var(--card);margin-bottom:8px}
      #shiftTable td{border:none;padding:4px 0}
      #shiftTable td::before{content:attr(data-label) " "; display:block; font-size:11px; color:var(--muted); margin-bottom:2px}
      #shiftTable td.actions{display:flex;gap:6px;justify-content:flex-end}
      input,select,textarea,button{font-size:16px}
    }

    @media print{
      body{background:#fff;color:#000}
      header, .no-print{display:none !Important}
      table{border-spacing:0;border-collapse:collapse}
      th,td{border:1px solid #999;padding:6px}
      tr{background:#fff}
    }

    /* TEME */
    :root[data-theme="dark"]{
      --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#22c55e; --accent2:#3b82f6; --warn:#f59e0b; --danger:#ef4444;
      --chip:#1f2937; --card:#0b1220; --border:#1f2937;
    }
    :root[data-theme="light"]{
      --bg:#f5f6fa; --panel:#ffffff; --muted:#5b6577; --text:#10121a;
      --accent:#16a34a; --accent2:#2563eb; --warn:#b45309; --danger:#b91c1c;
      --chip:#edf0f7; --card:#ffffff; --border:#e5e7eb;
    }
    :root[data-theme="midnight"]{
      --bg:#0b1020; --panel:#0a0f1d; --muted:#8aa0bf; --text:#e8efff;
      --accent:#7c3aed; --accent2:#3b82f6; --warn:#f59e0b; --danger:#ef4444;
      --chip:#0f1a33; --card:#0b1228; --border:#142042;
    }
    :root[data-theme="forest"]{
      --bg:#0d1512; --panel:#0f1f19; --muted:#9bb2a3; --text:#e9f5ee;
      --accent:#22c55e; --accent2:#0ea5e9; --warn:#d97706; --danger:#dc2626;
      --chip:#123122; --card:#0e2018; --border:#1a3a2a;
    }
    :root[data-theme="amber"]{
      --bg:#1a1300; --panel:#1f1600; --muted:#e9d8a6; --text:#fff7cc;
      --accent:#f59e0b; --accent2:#fbbf24; --warn:#f97316; --danger:#ef4444;
      --chip:#2a2005; --card:#221a04; --border:#3a2b08;
    }
    :root[data-theme="corporate"]{
      --bg:#0e1626; --panel:#10182a; --muted:#aab4c6; --text:#f1f5fb;
      --accent:#2563eb; --accent2:#0ea5e9; --warn:#eab308; --danger:#ef4444;
      --chip:#152038; --card:#0f1930; --border:#1c2a4a;
    }
    :root[data-theme="contrast"]{
      --bg:#000; --panel:#000; --muted:#bbb; --text:#fff;
      --accent:#00ff5a; --accent2:#00b3ff; --warn:#ffd000; --danger:#ff4040;
      --chip:#111; --card:#000; --border:#333;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-top">
      <div class="title">Zoka</div>
      <div class="row no-print" style="gap:6px">
        <label class="chip" for="restoreInput" title="Učitaj backup">Učitaj backup<input id="restoreInput" type="file" accept="application/json" style="display:none"></label>
        <button id="btnBackup" class="primary">Preuzmi backup</button>
        <button id="btnShareBackup">Podeli backup</button>
        <button id="btnPrint">PDF (Štampa)</button>
        <button id="btnShareCSV">Podeli CSV</button>
      </div>
      <div class="row no-print" style="gap:6px; margin-left:auto">
        <label class="chip" for="themeSelect">Tema</label>
        <select id="themeSelect" style="min-width:160px">
          <option value="dark">Dark</option>
          <option value="light">Light</option>
          <option value="midnight">Midnight</option>
          <option value="forest">Forest</option>
          <option value="amber">Amber</option>
          <option value="corporate">Corporate</option>
          <option value="contrast">High Contrast</option>
        </select>
      </div>
    </div>
    <div class="tabs no-print">
      <div class="tab active" data-tab="events">Događaji</div>
      <div class="tab" data-tab="staff">Službenici</div>
      <div class="tab" data-tab="positions">Pozicije</div>
      <div class="tab" data-tab="shifts">Prisustvo</div>
    </div>
  </header>

  <div id="warn" class="warning">
    <div><b>Upozorenje:</b> Pregledač ne čuva podatke trajno. Otvori u Chrome/Safari ili koristi PWA. U međuvremenu klikni „Preuzmi backup“ da sačuvaš .json.</div>
    <div class="row">
      <button id="btnBackup2" class="danger">Preuzmi backup</button>
      <button id="btnShareBackup2">Podeli backup</button>
    </div>
  </div>

  <!-- DOGAĐAJI -->
  <main id="view-events" class="grid">
    <section class="card no-print">
      <div class="section-title">Događaji</div>
      <div class="row split">
        <input id="evName" placeholder="Naziv događaja" />
      </div>
      <div class="row split">
        <input id="evDateFrom" type="date" title="Datum od" />
        <input id="evDateTo" type="date" title="Datum do" />
      </div>
      <div class="row split">
        <input id="evResponsible" placeholder="Odgovorno lice (default: Zorica Mihajlović)" />
      </div>
      <div class="toolbar">
        <button class="success" id="btnAddEvent">Dodaj događaj</button>
        <button id="btnClearEvents" class="danger">Obriši sve događaje</button>
      </div>
      <div class="list" id="eventList"></div>
    </section>
    <section class="card">
      <div class="section-title">
        Trenutni događaj: <span id="currentEventLabel" class="badge">nema izabranog događaja</span>
      </div>
      <p class="muted">Izaberi događaj u levoj listi. U tabu <b>Prisustvo</b> unosiš i gledaš smene, sate i isplate.</p>
    </section>
  </main>

  <!-- SLUŽBENICI -->
  <main id="view-staff" class="grid" style="display:none">
    <section class="card">
      <div class="section-title">Službenici (direktorijum)</div>
      <div class="row split">
        <input id="staffName" placeholder="Ime i prezime" />
        <input id="staffDefaultRole" placeholder="Podrazumevana uloga (opciono)" />
      </div>
      <div class="toolbar">
        <button id="btnAddStaff" class="success">Dodaj službenika</button>
        <button id="btnImportStaff" class="ghost">Uvezi CSV</button>
        <button id="btnExportStaff" class="ghost">Izvezi CSV</button>
      </div>
      <input id="staffSearch" placeholder="Pretraga po imenu…" />
      <div class="list" id="staffList"></div>
    </section>
  </main>

  <!-- POZICIJE -->
  <main id="view-positions" class="grid" style="display:none">
    <section class="card">
      <div class="section-title">Pozicije (globalne)</div>
      <div class="row split">
        <input id="posName" placeholder="Naziv pozicije (npr. Ulaz A, Bina, Parking 2)" />
        <button id="btnAddPos" class="success">Dodaj poziciju</button>
      </div>
      <div id="posList" class="list"></div>
    </section>
  </main>

  <!-- PRISUSTVO / SMENE -->
  <main id="view-shifts" class="grid" style="display:none">
    <section class="card">
      <div class="section-title">Prisustvo (smene)</div>

      <div class="row split no-print">
        <select id="eventSelect"></select>
        <div class="chip" id="eventInfo">Nije izabran događaj</div>
      </div>

      <div class="row split no-print" style="margin-top:6px">
        <select id="staffSelect" multiple size="3" title="Izaberi jednog ili više službenika"></select>
        <input id="guardRole" placeholder="Uloga (opciono)" />
      </div>
      <div class="row split no-print">
        <input id="shiftDate" type="date" />
        <select id="guardPosition"><option value="">— odaberi poziciju —</option></select>
      </div>
      <div class="row split no-print">
        <input id="timeFrom" type="time" />
        <input id="timeTo" type="time" />
      </div>

      <div class="row split no-print">
        <select id="payType">
          <option value="hourly">Plaćanje po satu</option>
          <option value="flat">Dnevnica (po smeni)</option>
        </select>
        <input id="payRate" type="number" step="0.01" min="0" placeholder="Iznos (RSD)" />
      </div>

      <div class="row split no-print">
        <select id="shiftStatus">
          <option value="Regularna">Regularna</option>
          <option value="Zamena">Zamena</option>
          <option value="Incident">Incident</option>
        </select>
        <input id="shiftNote" placeholder="Napomena (opciono)" />
      </div>

      <div class="toolbar no-print">
        <div class="row" style="gap:6px">
          <button id="tpl1" class="ghost small">07:00–15:00</button>
          <button id="tpl2" class="ghost small">15:00–23:00</button>
          <button id="tpl3" class="ghost small">23:00–07:00</button>
          <button id="btnEditTemplates" class="ghost small">Uredi šablone</button>
        </div>
        <button id="btnDupLast" class="ghost small">Dupliciraj poslednju</button>
        <button id="btnAddShift" class="success">Dodaj smenu (za izabrane)</button>
        <button id="btnExportCSV" class="primary right">Izvezi CSV</button>
      </div>

      <div id="shiftTableWrap">
        <table id="shiftTable">
          <thead>
            <tr>
              <th>Datum</th><th>Službenik</th><th>Pozicija</th><th>Uloga</th>
              <th>Od</th><th>Do</th><th>Sati</th>
              <th>Plaćanje</th><th>Iznos (RSD)</th>
              <th>Status</th><th>Napomena</th><th class="no-print"></th>
            </tr>
          </thead>
          <tbody id="shiftBody"></tbody>
        </table>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="section-title">Rezimei</div>
        <div id="summaryTotals" class="list"></div>
      </div>
    </section>
  </main>

  <script>
  document.addEventListener('DOMContentLoaded', function(){
    /* SW */
    try{
      if('serviceWorker' in navigator){
        window.addEventListener('load', function(){
          try{ navigator.serviceWorker.register('./sw.js?v=82'); }catch(e){}
        });
      }
    }catch(e){}

    /* Tema */
    var THEME_KEY='zoka_theme';
    var themeSelect=document.getElementById('themeSelect');
    function applyTheme(name){
      try{
        document.documentElement.setAttribute('data-theme', name);
        try{ localStorage.setItem(THEME_KEY, name); }catch(e){}
        var meta=document.querySelector('meta[name="theme-color"]');
        if(meta){
          var bg=getComputedStyle(document.documentElement).getPropertyValue('--bg');
          if(bg){ meta.setAttribute('content', bg.trim()); }
        }
      }catch(e){}
    }
    (function initTheme(){
      var t=null; try{ t=localStorage.getItem(THEME_KEY); }catch(e){}
      if(!t){
        try{
          var prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
          t = prefersLight ? 'light' : 'dark';
        }catch(e){ t='dark'; }
      }
      applyTheme(t);
      if(themeSelect){ themeSelect.value=t; themeSelect.addEventListener('change', function(e){ applyTheme(e.target.value); }); }
    })();

    /* Storage & State */
    var LS_KEY='zoka_v82';
    var storageOK=true;
    try{ localStorage.setItem('__zoka_test','ok'); storageOK = (localStorage.getItem('__zoka_test')==='ok'); localStorage.removeItem('__zoka_test'); }catch(e){ storageOK=false; }
    var warn=document.getElementById('warn'); if(!storageOK && warn){ warn.classList.add('show'); }
    function cryptoRandom(){ return Math.random().toString(36).slice(2,10)+Date.now().toString(36).slice(-4); }
    function defaultTemplates(){ return [
      { id:'t1', label:'07:00–15:00', from:'07:00', to:'15:00' },
      { id:'t2', label:'15:00–23:00', from:'15:00', to:'23:00' },
      { id:'t3', label:'23:00–07:00', from:'23:00', to:'07:00' }
    ]; }
    function loadRaw(){
      if(!storageOK) return { events:[], selectedEventId:null, staff:[], positions:[], templates:defaultTemplates() };
      try{
        var raw = localStorage.getItem(LS_KEY);
        if(raw) return JSON.parse(raw);
      }catch(e){}
      return { events:[], selectedEventId:null, staff:[], positions:[], templates:defaultTemplates() };
    }
    function saveRaw(){ if(storageOK){ try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); }catch(e){} } }
    var state = loadRaw();

    /* Helpers */
    function $(sel){ return document.querySelector(sel); }
    function el(tag, attrs){
      var node=document.createElement(tag);
      if(attrs){
        for(var k in attrs){
          if(k==='class'){ node.className=attrs[k]; }
          else if(k==='dataset'){ var ds=attrs[k]; for(var dk in ds){ node.dataset[dk]=ds[dk]; } }
          else if(k.indexOf('on')===0 && typeof attrs[k]==='function'){ node.addEventListener(k.slice(2), attrs[k]); }
          else if(attrs[k]!==undefined && attrs[k]!==null){ node.setAttribute(k, attrs[k]); }
        }
      }
      for(var i=2;i<arguments.length;i++){ var c=arguments[i]; node.appendChild(c instanceof Node? c : document.createTextNode(String(c))); }
      return node;
    }
    function minutes(hhmm){ var parts=(hhmm||'').split(':'); var h=parseInt(parts[0],10), m=parseInt(parts[1],10); if(isNaN(h)||isNaN(m)) return null; return h*60+m; }
    function hoursDiff(from,to){ var a=minutes(from), b=minutes(to); if(a===null||b===null) return 0; if(b<a) b+=1440; return Math.round(((b-a)/60)*100)/100; }
    function overlap(f1,t1,f2,t2){
      function span(f,t){ var s=minutes(f), e=minutes(t); if(s===null||e===null) return null; if(e<s) e+=1440; return [s,e]; }
      var A=span(f1,t1), B=span(f2,t2); if(!A||!B) return false; return Math.max(A[0],B[0]) < Math.min(A[1],B[1]);
    }
    function moneyFmt(v){
      var n = Number(v||0);
      try{ return n.toLocaleString('sr-RS',{minimumFractionDigits:2,maximumFractionDigits:2}); }catch(e){ return (Math.round(n*100)/100).toFixed(2); }
    }
    function formatDate(d){ try{ return d ? new Date(d).toLocaleDateString('sr-Latn-RS') : ''; }catch(e){ return d||''; } }
    function formatRange(ev){ var a=formatDate(ev.dateFrom), b=formatDate(ev.dateTo); return (a&&b)?(a===b?a:(a+' – '+b)):(a||b||''); }

    /* Tabs */
    var tabs=document.querySelectorAll('.tab');
    var views={
      events: $('#view-events'),
      staff: $('#view-staff'),
      positions: $('#view-positions'),
      shifts: $('#view-shifts')
    };
    for(var ti=0; ti<tabs.length; ti++){
      tabs[ti].addEventListener('click', function(){
        for(var tj=0; tj<tabs.length; tj++) tabs[tj].classList.remove('active');
        this.classList.add('active');
        var id=this.getAttribute('data-tab');
        for(var k in views){ if(views[k]) views[k].style.display = (k===id? 'grid':'none'); }
      });
    }

    /* Backup / deljenje / CSV / PDF */
    function downloadBlob(data, name, type){
      try{
        var blob=new Blob([data],{type:type});
        var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name;
        document.body.appendChild(a); a.click(); a.remove();
        setTimeout(function(){ URL.revokeObjectURL(a.href); },1000);
        return blob;
      }catch(e){ alert('Greška pri preuzimanju: '+e.message); }
    }
    function backup(){
      downloadBlob(JSON.stringify(state,null,2), 'zoka_backup_'+new Date().toISOString().slice(0,10)+'.json', 'application/json');
    }
    var btnBackup=document.getElementById('btnBackup'); if(btnBackup) btnBackup.addEventListener('click', backup);
    var btnBackup2=document.getElementById('btnBackup2'); if(btnBackup2) btnBackup2.addEventListener('click', backup);

    async function shareFile(name, blob, type){
      try{
        var file=new File([blob], name, {type:type});
        if(navigator.canShare && navigator.canShare({files:[file]})){
          await navigator.share({files:[file], title:'Zoka', text:'Deljenje fajla'});
        }else{
          downloadBlob(await blob.arrayBuffer(), name, type);
          alert('Fajl je sačuvan u Downloads – podeli ga ručno.');
        }
      }catch(e){
        if(!(e && e.name==='AbortError')) alert('Deljenje nije uspelo: '+e.message);
      }
    }
    async function shareBackup(){
      var blob = new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
      await shareFile('zoka_backup_'+new Date().toISOString().slice(0,10)+'.json', blob, 'application/json');
    }
    var btnShareBackup=document.getElementById('btnShareBackup'); if(btnShareBackup) btnShareBackup.addEventListener('click', function(){ shareBackup(); });
    var btnShareBackup2=document.getElementById('btnShareBackup2'); if(btnShareBackup2) btnShareBackup2.addEventListener('click', function(){ shareBackup(); });

    function makeCSV(){
      var ev = state.events.filter(function(e){return e.id===state.selectedEventId;})[0];
      if(!ev) return {csv:'',name:'smene.csv'};
      var posMap={}; for(var i=0;i<state.positions.length;i++){ posMap[state.positions[i].id]=state.positions[i].name; }
      var rows=[['Događaj','Period','Odgovorno lice','Datum smene','Službenik','Uloga','Pozicija','Od','Do','Sati','Plaćanje','Iznos (RSD)','Status','Napomena']];
      for(var j=0;j<(ev.shifts||[]).length;j++){
        var s=ev.shifts[j];
        rows.push([
          ev.name, formatRange(ev), ev.responsible||'',
          s.date||'', s.guard||'', s.role||'', posMap[s.posId]||'',
          s.from||'', s.to||'', (s.hours||0).toFixed(2),
          s.payType==='flat'?'Dnevnica':'Po satu',
          (s.amount||0).toFixed(2), s.status||'', s.note||''
        ]);
      }
      var csv = rows.map(function(r){
        return r.map(function(x){
          var s = (x==null?'':String(x));
          return (s.indexOf(';')>-1 || s.indexOf('"')>-1 || s.indexOf('\n')>-1) ? '"'+s.replace(/"/g,'""')+'"' : s;
        }).join(';');
      }).join('\n');
      var name = 'smene_'+(ev.name||'dogadjaj').replace(/\s+/g,'_')+'.csv';
      return {csv:csv,name:name};
    }
    var btnExportCSV=document.getElementById('btnExportCSV');
    if(btnExportCSV){ btnExportCSV.addEventListener('click', function(){
      var out=makeCSV(); if(!out.csv){ alert('Izaberi događaj.'); return; }
      downloadBlob(out.csv, out.name, 'text/csv;charset=utf-8;');
    });}
    var btnShareCSV=document.getElementById('btnShareCSV');
    if(btnShareCSV){ btnShareCSV.addEventListener('click', async function(){
      var out=makeCSV(); if(!out.csv){ alert('Izaberi događaj.'); return; }
      await shareFile(out.name, new Blob([out.csv],{type:'text/csv'}), 'text/csv');
    });}

    function printPDF(){
      var ev = state.events.filter(function(e){return e.id===state.selectedEventId;})[0];
      if(!ev){ alert('Izaberi događaj.'); return; }
      var posMap={}; for(var i=0;i<state.positions.length;i++){ posMap[state.positions[i].id]=state.positions[i].name; }
      var rows=(ev.shifts||[]).slice().sort(function(a,b){
        var d=(a.date||'').localeCompare(b.date||''); if(d!==0) return d;
        return (a.from||'').localeCompare(b.from||'');
      });
      var totalHours=0, totalAmount=0;
      for(i=0;i<rows.length;i++){ totalHours+=rows[i].hours||0; totalAmount+=rows[i].amount||0; }
      var win=window.open('', '_blank');
      var css='<style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;padding:16px;color:#000;}h2{margin:0 0 8px} .muted{color:#555} table{width:100%;border-collapse:collapse} th,td{border:1px solid #999;padding:6px;text-align:left;vertical-align:top;font-size:12px} .sign{margin-top:20px;display:flex;gap:32px} .box{border:1px solid #999;padding:12px;min-height:80px;flex:1} .sum{margin-top:12px}</style>';
      var head='<h2>'+ (ev.name||'Događaj') +' – '+formatRange(ev)+'</h2><div class="muted">Odgovorno lice: '+(ev.responsible||'')+'</div><div class="sum"><b>Ukupno sati:</b> '+totalHours.toFixed(2)+' • <b>Ukupan iznos:</b> '+moneyFmt(totalAmount)+' RSD</div>';
      var tableHead='<table><thead><tr><th>#</th><th>Datum</th><th>Službenik</th><th>Uloga</th><th>Pozicija</th><th>Od</th><th>Do</th><th>Sati</th><th>Plaćanje</th><th>Iznos</th><th>Status</th><th>Napomena</th></tr></thead><tbody>';
      var tableRows='';
      for(i=0;i<rows.length;i++){
        var s=rows[i];
        tableRows+='<tr><td>'+ (i+1) +'</td><td>'+ (s.date||'') +'</td><td>'+ (s.guard||'') +'</td><td>'+ (s.role||'') +'</td><td>'+ (posMap[s.posId]||'') +'</td><td>'+ (s.from||'') +'</td><td>'+ (s.to||'') +'</td><td>'+ (s.hours||0).toFixed(2) +'</td><td>'+ (s.payType==='flat'?'Dnevnica':'Po satu') +'</td><td>'+ moneyFmt(s.amount||0) +'</td><td>'+ (s.status||'') +'</td><td>'+ (s.note||'') +'</td></tr>';
      }
      var foot='</tbody></table><div class="sign"><div class="box">Šef smene:</div><div class="box">Nadzor/klijent:</div><div class="box">Odgovorno lice: '+(ev.responsible||'')+'</div></div>';
      win.document.write('<html><head><meta charset="UTF-8"><title>Štampa – '+(ev.name||'')+'</title>'+css+'</head><body>'+head+tableHead+tableRows+foot+'</body></html>');
      win.document.close(); win.focus(); win.onload=function(){ win.print(); };
    }
    var btnPrint=document.getElementById('btnPrint'); if(btnPrint) btnPrint.addEventListener('click', printPDF);

    /* EVENTS */
    var eventList=document.getElementById('eventList');
    var currentEventLabel=document.getElementById('currentEventLabel');
    function renderEvents(){
      if(!eventList) return;
      eventList.innerHTML='';
      var events = state.events.slice().sort(function(a,b){ return (a.dateFrom||'').localeCompare(b.dateFrom||''); });
      if(events.length===0){ eventList.appendChild(el('div',{class:'muted'},'Nema događaja. Dodaj prvi iznad.')); return; }
      for(var i=0;i<events.length;i++){
        (function(ev){
          var hrs=0, amt=0, k;
          for(k=0;k<(ev.shifts||[]).length;k++){ hrs+=ev.shifts[k].hours||0; amt+=ev.shifts[k].amount||0; }
          var isSel = ev.id===state.selectedEventId;
          eventList.appendChild(
            el('div',{class:'item'},
              el('div',{}, el('div',{}, ev.name||'Bez naziva'),
                el('div',{class:'muted'}, formatRange(ev) || '—'),
                el('div',{class:'muted'}, 'Odgovorno: '+(ev.responsible||'')) ),
              el('div',{class:'row'},
                el('span',{class:'chip'}, String((ev.shifts||[]).length)+' smena'),
                el('span',{class:'chip'}, hrs.toFixed(2)+' h'),
                el('span',{class:'chip'}, moneyFmt(amt)+' RSD'),
                el('button',{class:'ghost',onclick:function(){ state.selectedEventId=ev.id; saveRaw(); renderAll(); }}, isSel?'Izabrano':'Otvori'),
                el('button',{class:'ghost',onclick:function(){ delEvent(ev.id); }}, 'Obriši')
              )
            )
          );
        })(events[i]);
      }
    }
    function delEvent(id){
      if(!confirm('Obrisati događaj?')) return;
      state.events = state.events.filter(function(e){return e.id!==id;});
      if(state.selectedEventId===id) state.selectedEventId = (state.events[0] && state.events[0].id) || null;
      saveRaw(); renderAll();
    }
    var btnAddEvent=document.getElementById('btnAddEvent');
    if(btnAddEvent){ btnAddEvent.addEventListener('click', function(){
      var name = (document.getElementById('evName').value||'').trim();
      var df = (document.getElementById('evDateFrom').value||'');
      var dt = (document.getElementById('evDateTo').value||'');
      var resp = (document.getElementById('evResponsible').value||'').trim() || 'Zorica Mihajlović';
      if(!name){ alert('Unesi naziv događaja.'); return; }
      if(df && dt && df>dt){ alert('„Datum do“ ne može biti pre „Datum od“.'); return; }
      var ev = { id: cryptoRandom(), name:name, dateFrom: df||'', dateTo: dt||'', responsible: resp, shifts:[] };
      state.events.push(ev); state.selectedEventId = ev.id;
      document.getElementById('evName').value=''; document.getElementById('evDateFrom').value=''; document.getElementById('evDateTo').value=''; document.getElementById('evResponsible').value='';
      saveRaw(); renderAll(); updateEventSelect();
    });}
    var btnClearEvents=document.getElementById('btnClearEvents');
    if(btnClearEvents){ btnClearEvents.addEventListener('click', function(){
      if(!confirm('Obrisati SVE događaje i podatke?')) return;
      state.events=[]; state.selectedEventId=null; saveRaw(); renderAll(); updateEventSelect();
    });}

    /* STAFF */
    var staffList=document.getElementById('staffList');
    var staffSearch=document.getElementById('staffSearch');
    function renderStaff(){
      if(!staffList) return;
      staffList.innerHTML='';
      var q = (staffSearch && staffSearch.value ? staffSearch.value.toLowerCase() : '');
      var items = state.staff.slice().sort(function(a,b){ return a.name.localeCompare(b.name,'sr'); })
                    .filter(function(s){ return String(s.name||'').toLowerCase().indexOf(q)>-1; });
      if(items.length===0){ staffList.appendChild(el('div',{class:'muted'}, 'Nema službenika. Dodaj iznad.')); return; }
      for(var i=0;i<items.length;i++){
        (function(s){
          staffList.appendChild(el('div',{class:'item'},
            el('div',{}, el('div',{}, s.name), el('div',{class:'muted'}, s.role||'—')),
            el('div',{class:'row'},
              el('button',{class:'ghost',onclick:function(){ editStaff(s.id); }},'Uredi'),
              el('button',{class:'ghost',onclick:function(){ delStaff(s.id); }},'Obriši')
            )
          ));
        })(items[i]);
      }
    }
    function addStaff(){
      var name = (document.getElementById('staffName').value||'').trim();
      if(!name){ alert('Unesi ime i prezime.'); return; }
      var role = (document.getElementById('staffDefaultRole').value||'').trim();
      state.staff.push({id:cryptoRandom(), name:name, role:role});
      document.getElementById('staffName').value=''; document.getElementById('staffDefaultRole').value='';
      saveRaw(); renderStaff(); renderShiftFormSources();
    }
    function delStaff(id){
      if(!confirm('Obrisati službenika iz direktorijuma? Ovo ne menja postojeće smene.')) return;
      state.staff = state.staff.filter(function(s){return s.id!==id;});
      saveRaw(); renderStaff(); renderShiftFormSources();
    }
    function editStaff(id){
      var s = state.staff.filter(function(x){return x.id===id;})[0]; if(!s) return;
      var nn = prompt('Ime i prezime:', s.name); if(nn===null) return;
      var nr = prompt('Podrazumevana uloga (opciono):', s.role||''); if(nr===null) return;
      s.name=(nn||'').trim(); s.role=(nr||'').trim(); saveRaw(); renderStaff(); renderShiftFormSources();
    }
    var btnAddStaff=document.getElementById('btnAddStaff'); if(btnAddStaff) btnAddStaff.addEventListener('click', addStaff);
    if(staffSearch) staffSearch.addEventListener('input', renderStaff);

    var btnExportStaff=document.getElementById('btnExportStaff');
    if(btnExportStaff){ btnExportStaff.addEventListener('click', function(){
      var rows=[['Ime i prezime','Uloga']];
      for(var i=0;i<state.staff.length;i++) rows.push([state.staff[i].name, state.staff[i].role||'']);
      var csv = rows.map(function(r){ return r.map(function(x){ var t=(x==null?'':String(x)); return t.indexOf(',')>-1?('"'+t.replace(/"/g,'""')+'"'):t; }).join(','); }).join('\n');
      downloadBlob(csv, 'sluzbenici.csv', 'text/csv');
    });}
    var btnImportStaff=document.getElementById('btnImportStaff');
    if(btnImportStaff){ btnImportStaff.addEventListener('click', function(){
      var inp=document.createElement('input'); inp.type='file'; inp.accept='.csv,text/csv';
      inp.onchange=function(e){
        var f=e.target.files && e.target.files[0]; if(!f) return;
        var r=new FileReader();
        r.onload=function(){
          try{
            var lines=String(r.result).split(/\r?\n/).filter(function(x){return x.trim().length>0;});
            var start = (lines[0]||'').toLowerCase().indexOf('ime')>-1 ? 1 : 0;
            for(var i=start;i<lines.length;i++){
              var parts = lines[i].split(',').map(function(s){ return s.replace(/^"|"$/g,'').replace(/""/g,'"').trim(); });
              if(!parts[0]) continue;
              state.staff.push({id:cryptoRandom(), name:parts[0], role:parts[1]||''});
            }
            saveRaw(); renderStaff(); renderShiftFormSources(); alert('Uvezeno.');
          }catch(err){ alert('Greška pri uvozu: '+err.message); }
        };
        r.readAsText(f);
      };
      inp.click();
    });}

    /* POSITIONS */
    var posList=document.getElementById('posList');
    function renderPositions(){
      if(!posList) return;
      posList.innerHTML='';
      var items = state.positions.slice().sort(function(a,b){ return a.name.localeCompare(b.name,'sr'); });
      if(items.length===0){ posList.appendChild(el('div',{class:'muted'},'Nema pozicija. Dodaj iznad.')); return; }
      for(var i=0;i<items.length;i++){
        (function(p){
          posList.appendChild(el('div',{class:'item'},
            el('div',{}, p.name),
            el('div',{class:'row'},
              el('button',{class:'ghost',onclick:function(){ renamePos(p.id); }},'Preimenuj'),
              el('button',{class:'ghost',onclick:function(){ delPos(p.id); }},'Obriši')
            )
          ));
        })(items[i]);
      }
    }
    function addPos(){
      var name = (document.getElementById('posName').value||'').trim(); if(!name) return;
      state.positions.push({id:cryptoRandom(), name:name});
      document.getElementById('posName').value=''; saveRaw(); renderPositions(); renderShiftFormSources();
    }
    function delPos(id){
      if(!confirm('Obrisati poziciju? Postojeće smene će ostati bez dodeljene pozicije.')) return;
      state.positions = state.positions.filter(function(p){return p.id!==id;});
      for(var evi=0;evi<state.events.length;evi++){
        var ev=state.events[evi];
        for(var si=0; si<(ev.shifts||[]).length; si++){ if(ev.shifts[si].posId===id) ev.shifts[si].posId=''; }
      }
      saveRaw(); renderPositions(); renderShifts(); renderShiftFormSources();
    }
    function renamePos(id){
      var p = state.positions.filter(function(x){return x.id===id;})[0]; if(!p) return;
      var nn = prompt('Novi naziv pozicije:', p.name); if(!nn || !nn.trim()) return;
      p.name = nn.trim(); saveRaw(); renderPositions(); renderShiftFormSources(); renderShifts();
    }
    var btnAddPos=document.getElementById('btnAddPos'); if(btnAddPos) btnAddPos.addEventListener('click', addPos);

    /* SHIFTS */
    var eventSelect=document.getElementById('eventSelect');
    var eventInfo=document.getElementById('eventInfo');
    var shiftBody=document.getElementById('shiftBody');
    var staffSelect=document.getElementById('staffSelect');
    var positionSelect=document.getElementById('guardPosition');
    var shiftDate=document.getElementById('shiftDate');

    function renderEventInfoChip(){
      var ev = state.events.filter(function(e){return e.id===state.selectedEventId;})[0];
      if(eventInfo) eventInfo.textContent = ev ? (ev.name+' • '+formatRange(ev)+' • Odgovorno: '+(ev.responsible||'')) : 'Nije izabran događaj';
    }
    function updateEventSelect(){
      if(!eventSelect) return;
      eventSelect.innerHTML='';
      var opt=document.createElement('option'); opt.value=''; opt.textContent='— izaberi događaj —'; eventSelect.appendChild(opt);
      var events = state.events.slice().sort(function(a,b){ return (a.dateFrom||'').localeCompare(b.dateFrom||''); });
      for(var i=0;i<events.length;i++){
        var ev=events[i]; var o=document.createElement('option'); o.value=ev.id; o.textContent=ev.name+' ('+formatRange(ev)+')'; eventSelect.appendChild(o);
      }
      eventSelect.value = state.selectedEventId || '';
      renderEventInfoChip();
    }
    if(eventSelect){ eventSelect.addEventListener('change', function(){ state.selectedEventId = eventSelect.value || null; saveRaw(); renderAll(); }); }

    function renderShiftFormSources(){
      if(staffSelect){
        staffSelect.innerHTML='';
        if(state.staff.length===0){
          var op=document.createElement('option'); op.disabled=true; op.textContent='Nema službenika – dodaj u tabu „Službenici“.';
          staffSelect.appendChild(op);
        }else{
          var sitems = state.staff.slice().sort(function(a,b){ return a.name.localeCompare(b.name,'sr'); });
          for(var i=0;i<sitems.length;i++){ var o=document.createElement('option'); o.value=sitems[i].id; o.textContent=sitems[i].name; staffSelect.appendChild(o); }
        }
      }
      if(positionSelect){
        positionSelect.innerHTML='<option value="">— odaberi poziciju —</option>';
        var pitems = state.positions.slice().sort(function(a,b){ return a.name.localeCompare(b.name,'sr'); });
        for(var j=0;j<pitems.length;j++){ var po=document.createElement('option'); po.value=pitems[j].id; po.textContent=pitems[j].name; positionSelect.appendChild(po); }
      }
      var ev = state.events.filter(function(e){return e.id===state.selectedEventId;})[0];
      if(shiftDate) shiftDate.value = ev ? (ev.dateFrom||'') : '';
    }

    function computeAmount(payType, rate, hours){
      var r = Number(rate||0);
      return (payType==='flat') ? r : Math.max(0, Number(hours||0)*r);
    }

    function renderShifts(){
      if(!shiftBody) return;
      shiftBody.innerHTML='';
      var ev = state.events.filter(function(e){return e.id===state.selectedEventId;})[0];
      if(!ev){
        if(currentEventLabel) currentEventLabel.textContent='nema izabranog događaja';
        renderEventInfoChip();
        shiftBody.appendChild(el('tr',{}, el('td',{colspan:'12',class:'muted'},'Izaberi događaj u padajućoj listi iznad.')));
        var st=document.getElementById('summaryTotals'); if(st) st.innerHTML='';
        return;
      }
      if(currentEventLabel) currentEventLabel.textContent = ev.name+' • '+formatRange(ev);
      renderEventInfoChip();

      var i;
      for(i=0;i<(ev.shifts||[]).length;i++){
        var s=ev.shifts[i];
        s.hours = hoursDiff(s.from, s.to);
        s.amount = computeAmount(s.payType, s.rate, s.hours);
      }

      var posMap={}; for(i=0;i<state.positions.length;i++){ posMap[state.positions[i].id]=state.positions[i].name; }
      var rows=(ev.shifts||[]).slice().sort(function(a,b){
        var d=(a.date||'').localeCompare(b.date||''); if(d!==0) return d;
        return (a.from||'').localeCompare(b.from||'');
      });
      if(rows.length===0) shiftBody.appendChild(el('tr',{}, el('td',{colspan:'12',class:'muted'},'Nema smena. Dodaj iznad.')));
      for(i=0;i<rows.length;i++){
        (function(s){
          var tr=el('tr',{},
            el('td',{'data-label':'Datum'}, s.date||''),
            el('td',{'data-label':'Službenik'}, s.guard||''),
            el('td',{'data-label':'Pozicija'}, posMap[s.posId]||'—'),
            el('td',{'data-label':'Uloga'}, s.role||'—'),
            el('td',{'data-label':'Od'}, s.from||''),
            el('td',{'data-label':'Do'}, s.to||''),
            el('td',{'data-label':'Sati'}, (s.hours||0).toFixed(2)),
            el('td',{'data-label':'Plaćanje'}, s.payType==='flat'?'Dnevnica':'Po satu'),
            el('td',{'data-label':'Iznos (RSD)'}, moneyFmt(s.amount||0)),
            el('td',{'data-label':'Status'}, s.status||'Regularna'),
            el('td',{'data-label':'Napomena'}, s.note||'—'),
            (function(){ var td=el('td',{class:'actions no-print'});
              td.appendChild(el('button',{class:'ghost small',onclick:function(){ editShift(s.id); }},'Uredi'));
              td.appendChild(el('button',{class:'ghost small',onclick:function(){ delShift(s.id); }},'Obriši'));
              return td; })()
          );
          shiftBody.appendChild(tr);
        })(rows[i]);
      }
      renderSummaries(ev);
    }

    function renderSummaries(ev){
      var wrap=document.getElementById('summaryTotals'); if(!wrap) return;
      wrap.innerHTML='';

      var byDay={}; var i;
      for(i=0;i<(ev.shifts||[]).length;i++){
        var s=ev.shifts[i]; var k=s.date||'—';
        if(!byDay[k]) byDay[k]={hours:0,amount:0};
        byDay[k].hours += s.hours||0; byDay[k].amount += s.amount||0;
      }
      var dayStr=[]; var days=Object.keys(byDay).sort();
      for(i=0;i<days.length;i++){ var d=days[i]; dayStr.push(d+': '+byDay[d].hours.toFixed(2)+' h • '+moneyFmt(byDay[d].amount)+' RSD'); }
      wrap.appendChild(el('div',{class:'item'}, el('div',{}, el('div',{style:'font-weight:600'},'Zbir po danima')), el('div',{}, dayStr.join(' | ')) ));

      var byGuard={};
      for(i=0;i<(ev.shifts||[]).length;i++){
        s=ev.shifts[i]; var g=s.guard||'—'; if(!byGuard[g]) byGuard[g]={hours:0,amount:0};
        byGuard[g].hours+=s.hours||0; byGuard[g].amount+=s.amount||0;
      }
      var guards=Object.keys(byGuard).sort(function(a,b){ return a.localeCompare(b,'sr'); });
      var gStr=[]; for(i=0;i<guards.length;i++){ var gg=guards[i]; gStr.push(gg+': '+byGuard[gg].hours.toFixed(2)+' h • '+moneyFmt(byGuard[gg].amount)+' RSD'); }
      wrap.appendChild(el('div',{class:'item'}, el('div',{}, el('div',{style:'font-weight:600'},'Zbir po službeniku')), el('div',{}, gStr.join(' | ')) ));

      var totalHours=0,totalAmount=0;
      for(i=0;i<(ev.shifts||[]).length;i++){ totalHours+=ev.shifts[i].hours||0; totalAmount+=ev.shifts[i].amount||0; }
      wrap.appendChild(el('div',{class:'item'}, el('div',{}, el('div',{style:'font-weight:600'},'Ukupno za događaj')), el('div',{}, totalHours.toFixed(2)+' h • '+moneyFmt(totalAmount)+' RSD') ));
    }

    function addShiftBulk(fromDup){
      var ev = state.events.filter(function(e){return e.id===state.selectedEventId;})[0];
      if(!ev){ alert('Izaberi događaj.'); return; }
      var date = fromDup && fromDup.date ? fromDup.date : (shiftDate ? shiftDate.value : '') || ev.dateFrom || '';
      var selectedStaffIds=[]; if(staffSelect){ var opts=staffSelect.selectedOptions||[]; for(var i=0;i<opts.length;i++) selectedStaffIds.push(opts[i].value); }
      if(!fromDup && selectedStaffIds.length===0){ alert('Izaberi bar jednog službenika (Ctrl/duži tap za više).'); return; }

      var role = fromDup ? fromDup.role : ((document.getElementById('guardRole')||{}).value||'').trim();
      var posId = fromDup ? fromDup.posId : ((document.getElementById('guardPosition')||{}).value||'');
      var from  = fromDup ? fromDup.from  : ((document.getElementById('timeFrom')||{}).value||'');
      var to    = fromDup ? fromDup.to    : ((document.getElementById('timeTo')||{}).value||'');
      var payType = fromDup ? fromDup.payType : ((document.getElementById('payType')||{}).value||'hourly');
      var rate    = Number( fromDup ? fromDup.rate : ((document.getElementById('payRate')||{}).value||'0') );
      var status= fromDup ? fromDup.status : ((document.getElementById('shiftStatus')||{}).value||'Regularna');
      var note  = fromDup ? fromDup.note   : ((document.getElementById('shiftNote')||{}).value||'');

      if(!date){ alert('Unesi datum smene.'); return; }
      if(!from || !to){ alert('Unesi vreme od–do.'); return; }
      var h = hoursDiff(from,to);
      var amount = (payType==='flat') ? Number(rate||0) : Math.max(0, h*Number(rate||0));

      function addOne(guardName){
        if(posId){
          var overl=false;
          for(var i=0;i<(ev.shifts||[]).length;i++){
            var s=ev.shifts[i];
            if(s.posId===posId && s.date===date && overlap(s.from,s.to,from,to)){ overl=true; break; }
          }
          if(overl && !confirm('Upozorenje: postoji preklapanje smena na istoj poziciji istog dana. Nastaviti?')) return;
        }
        ev.shifts.push({ id:cryptoRandom(), date:date, guard:guardName, role:role, posId:posId, from:from, to:to, hours:h, status:status, note:note, payType:payType, rate:rate, amount:amount });
      }

      if(fromDup){
        addOne(fromDup.guard);
      }else{
        for(var i=0;i<selectedStaffIds.length;i++){
          var st = state.staff.filter(function(x){return x.id===selectedStaffIds[i];})[0];
          addOne(st ? st.name : 'Nepoznat');
        }
      }
      saveRaw(); renderShifts();
      if(!fromDup){
        var sn=document.getElementById('shiftNote'); if(sn) sn.value='';
        var gr=document.getElementById('guardRole'); if(gr) gr.value='';
      }
    }
    
    var btnAddShift=document.getElementById('btnAddShift'); if(btnAddShift) btnAddShift.addEventListener('click', function(){ addShiftBulk(null); });
    var btnDupLast=document.getElementById('btnDupLast'); if(btnDupLast) btnDupLast.addEventListener('click', function(){
      var ev = state.events.filter(function(e){return e.id===state.selectedEventId;})[0]; if(!ev){ alert('Izaberi događaj.'); return; }
      var last = (ev.shifts||[]).length ? ev.shifts[ev.shifts.length-1] : null; if(!last){ alert('Nema prethodne smene.'); return; }
      addShiftBulk(last);
    });

    function delShift(id){
      var ev = state.events.filter(function(e){return e.id===state.selectedEventId;})[0]; if(!ev) return;
      ev.shifts = ev.shifts.filter(function(s){return s.id!==id;}); saveRaw(); renderShifts();
    }
    function editShift(id){
      var ev = state.events.filter(function(e){return e.id===state.selectedEventId;})[0]; if(!ev) return;
      var s = (ev.shifts||[]).filter(function(x){return x.id===id;})[0]; if(!s) return;

      var nd=prompt('Datum (YYYY-MM-DD):', s.date); if(nd===null) return;
      var ng=prompt('Službenik:', s.guard); if(ng===null) return;
      var nr=prompt('Uloga (opciono):', s.role||''); if(nr===null) return;
      var np=prompt('Pozicija (unesi tačan naziv, ili ostavi prazno):', (state.positions.filter(function(p){return p.id===s.posId;})[0]||{}).name||''); if(np===null) return;
      var pid=''; if(np){ var found = state.positions.filter(function(p){return p.name===np;})[0]; if(found) pid=found.id; }
      var nf=prompt('Od (hh:mm):', s.from); if(nf===null) return;
      var nt=prompt('Do (hh:mm):', s.to); if(nt===null) return;
      var npt=prompt('Plaćanje (hourly/flat):', s.payType||'hourly'); if(npt===null) return;
      var nr8=prompt('Iznos (RSD):', String(s.rate||0)); if(nr8===null) return;
      var ns=prompt('Status (Regularna/Zamena/Incident):', s.status||'Regularna'); if(ns===null) return;
      var nn=prompt('Napomena:', s.note||''); if(nn===null) return;

      s.date=(nd||'').trim(); s.guard=(ng||'').trim(); s.role=(nr||'').trim(); s.posId=pid;
      s.from=(nf||'').trim(); s.to=(nt||'').trim();
      s.payType=(npt==='flat'?'flat':'hourly'); s.rate=Number(nr8||0);
      s.status=(ns||'Regularna').trim(); s.note=(nn||'').trim();
      s.hours=hoursDiff(s.from,s.to); s.amount=computeAmount(s.payType,s.rate,s.hours);
      saveRaw(); renderShifts();
    }

    /* Šabloni */
    function applyTemplatesUI(){
      state.templates = state.templates && state.templates.length ? state.templates : defaultTemplates();
      var map={}; for(var i=0;i<state.templates.length;i++){ map[state.templates[i].id]=state.templates[i]; }
      var t1=map['t1'], t2=map['t2'], t3=map['t3'];
      var b1=document.getElementById('tpl1'), b2=document.getElementById('tpl2'), b3=document.getElementById('tpl3');
      if(b1 && t1){ b1.textContent=t1.label; b1.onclick=function(){ var tf=document.getElementById('timeFrom'); var tt=document.getElementById('timeTo'); if(tf) tf.value=t1.from; if(tt) tt.value=t1.to; }; }
      if(b2 && t2){ b2.textContent=t2.label; b2.onclick=function(){ var tf=document.getElementById('timeFrom'); var tt=document.getElementById('timeTo'); if(tf) tf.value=t2.from; if(tt) tt.value=t2.to; }; }
      if(b3 && t3){ b3.textContent=t3.label; b3.onclick=function(){ var tf=document.getElementById('timeFrom'); var tt=document.getElementById('timeTo'); if(tf) tf.value=t3.from; if(tt) tt.value=t3.to; }; }
    }
    var btnEditTemplates=document.getElementById('btnEditTemplates');
    if(btnEditTemplates){ btnEditTemplates.addEventListener('click', function(){
      state.templates = state.templates && state.templates.length ? state.templates : defaultTemplates();
      var map={}; for(var i=0;i<state.templates.length;i++){ map[state.templates[i].id]=state.templates[i]; }
      var keys=['t1','t2','t3'];
      for(var k=0;k<keys.length;k++){
        var id=keys[k]; var t = map[id] || {id:id,label:'',from:'',to:''};
        var nl = prompt('Etiketa šablona ('+id+'): ', t.label || '');
        if(nl===null) continue;
        var nf = prompt('Vreme OD (hh:mm):', t.from || '');
        if(nf===null) continue;
        var nt = prompt('Vreme DO (hh:mm):', t.to || '');
        if(nt===null) continue;
        var obj={id:id,label:(nl || (nf+'–'+nt)),from:nf||'',to:nt||''};
        var idx = -1; for(var ii=0;ii<state.templates.length;ii++) if(state.templates[ii].id===id){ idx=ii; break; }
        if(idx>=0) state.templates[idx]=obj; else state.templates.push(obj);
      }
      saveRaw(); applyTemplatesUI();
    });}

    /* Restore */
    var restoreInput=document.getElementById('restoreInput');
    if(restoreInput){
      restoreInput.addEventListener('change', function(e){
        var f=e.target.files && e.target.files[0]; if(!f) return;
        var r=new FileReader();
        r.onload=function(){
          try{
            var obj=JSON.parse(r.result);
            if(!obj || !obj.events || !obj.positions || !obj.staff) throw new Error('Nevažeći fajl');
            obj.templates = obj.templates && obj.templates.length ? obj.templates : defaultTemplates();
            state=obj; saveRaw(); renderAll(); updateEventSelect(); applyTemplatesUI(); alert('Backup učitan.');
          }catch(err){ alert('Greška: '+err.message); }
        };
        r.readAsText(f);
      });
    }

    /* Render ALL */
    function renderAll(){
      var ev = state.events.filter(function(e){return e.id===state.selectedEventId;})[0];
      if(currentEventLabel) currentEventLabel.textContent = ev ? (ev.name+' • '+formatRange(ev)) : 'nema izabranog događaja';
      renderEvents();
      renderPositions();
      renderStaff();
      renderShiftFormSources();
      updateEventSelect();
      applyTemplatesUI();
      renderShifts();
    }

    renderAll();
  }); // DOMContentLoaded
  </script>
</body>
</html>
